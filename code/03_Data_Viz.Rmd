---
title: "03 Data Viz"
output: html_notebook
---
Replication workflow for:

"Ideological Bias in Estimates of the Impact of Immigration"

[George J. Borjas](https://www.hks.harvard.edu/faculty/george-borjas) <br>
[Nate Brezau](https://sites.google.com/site/nbreznau/) <br>

The original workflow was developed by Borjas using Stata (see `reg_model.do` in this repository), and this workflow is an identical set of analyses by Breznau done in R. 

The file `df.rds` (also available as csv) was generated in the file `01_Data_Prep.Rmd`.

## Setup

```{r setup}

packages <- c("tidyverse",
              "knitr",
              "pacman",
              "here",
              "ragg",
              "margins",
              "ggplot2",
              "viridis",
              "ggridges")

pacman::p_load(packages, character.only = T)

```


## Data

```{r data}

df <- read_rds(here("data", "df.rds")) %>%
  # add in variables for distributional analyses
  mutate(negsig = ifelse(AME < 0 & abs(z) > 1.645, 1, 0),
         possig = ifelse(AME > 0 & abs(z) > 1.645, 1, 0),
         pos10 = ifelse(AME > .052, 1, 0),
         neg10 = ifelse(AME < -.071, 1, 0),
         pos10s = ifelse(AME > .052 & abs(z) > 1.645, 1, 0),
         neg10s = ifelse(AME < -.071 & abs(z) > 1.645, 1, 0),
         highstats = ifelse(statistics_skill == "High", 1, 0),
         hightopic = ifelse(topic_knowledge == "High", 1, 0),
         highmodel = ifelse(MODEL_SCORE == "High", 1, 0),
         proindex = pro_immigrant,
         t2 = case_when(team_size==1 ~ 1,
                        .default = 0),
         t3 = case_when(team_size==3 ~ 1,
                        .default = 0))

df <- df %>%
  group_by(u_teamid) %>%
  mutate(nmodel = n()) %>%
  ungroup()

```

## Hist

```{r h}
agg_png(here::here("results", "Fig1.png"), res = 144, width = 600, height = 550)

ggplot(df, aes(y = AME)) +
  geom_violin(
    aes(x = factor(index), fill = index)
  ) +
  stat_summary(
    aes(x = index-0.13, fill= index),
    fun = mean, color = "grey40",
  ) +
  stat_summary(
    aes(x = index-0.13, fill= index),
    fun.data = mean_sdl, fun.args = list(mult = 1),
    geom = "errorbar", color = "grey40",
    width = 0.2,
  ) +
  annotate("text", label = round(mean(df$AME[df$index == 1]), 3), 
           x = 1.2, y = .07, 
           color = "grey40", size = 3) +
  annotate("text", label = expression(italic("means:")), 
           x= 1.2, y = .13, 
           color = "grey40", size = 3) +
  annotate("text", label = format(round(mean(df$AME[df$index == 2]), 3), nsmall = 3),
           x = 2.2, y = .07, 
           color = "grey40", size = 3) +
  annotate("text", label = format(round(mean(df$AME[df$index == 3]), 3), nsmall = 3),
           x = 3.2, y = .07, 
           color = "grey40", size = 3) +
  scale_fill_viridis(begin = 0.2) +
  coord_cartesian(ylim = c(-0.4,0.4)) +
  scale_x_discrete(labels = c("1" = "Anti-imm",
                              "2" = "Moderate",
                              "3" = "Pro-imm")) +
  theme_classic() +
  theme(
    legend.position = "none",
    axis.title.x = element_blank()
  )
  
dev.off()

knitr::include_graphics(here::here("results", "Fig1.png"))

```

```{r ridges}
ggplot(df, aes(x = AME, fill = factor(index), y = factor(index))) +
  geom_density_ridges2() +
  coord_cartesian(xlim = c(-0.5,0.5)) +
  theme_classic()
  
```

