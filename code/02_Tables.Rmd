---
title: "02 Analyses"
output: false
---
Replication workflow for:

"Ideological Bias in Estimates of the Impact of Immigration"

[George J. Borjas](https://www.hks.harvard.edu/faculty/george-borjas) <br>
[Nate Brezau](https://sites.google.com/site/nbreznau/) <br>

The original workflow was developed by Borjas using Stata (see `reg_model.do` in this repository), and this workflow is an identical set of analyses by Breznau done in R. 

The file `df.rds` (also available as csv) was generated in the file `01_Data_Prep.Rmd`.

## Setup

```{r setup}

##### Packages

packages <- c("tidyverse",
              "knitr",
              "miceadds",
              "pacman",
              "here",
              #"jtools",
              #"sjPlot",
              "stringr",
              "sandwich",
              #"clubSandwich",
              "lmtest",
              "haven",
              "margins"
              #"car"
              #"numDeriv",
              #"pscl",
              #"mediation"
              )

pacman::p_load(packages, character.only = T)



##### FUNCTIONS

# function to get r-squared from lm.cluster

r2ext <- function(model) {
  summary_output <- capture.output(summary(model))
  combined_output <- paste(summary_output, collapse = " ")
  r2_pattern <- "R\\^2\\s*[:=]\\s*(\\d+\\.\\d+|\\d+)"
  cleaned_output <- str_replace(combined_output, "R\\^2\\s*[:=]\\s*", "")
  first_number <- round(as.numeric(str_extract(cleaned_output, "\\d+\\.\\d+|\\d+")),3)
  return(first_number)
}

# r-squared from lm

r2x <- function(x) {
  format(round(summary(x)$r.squared, 3), nsmall = 3)
}

add_asterisk_if_significant <- function(coef, se) {
  # Calculate the z-score
  z <- abs(coef / se)
  # Calculate the two-tailed p-value
  p_value <- 2 * (1 - pnorm(z))
  # Add an asterisk if p-value < 0.01
  if (p_value < 0.10) {
    return(paste0(format(round(coef, 3), nsmall = 3), "*"))
  } else {
    return(format(round(coef, 3), nsmall = 3))
  }
}

add_asterisk_if_significant_cluster <- function(coef, se) {
  # Calculate the z-score
  z <- abs(coef / se)
  # Calculate the two-tailed p-value
  p_value <- 2 * (1 - pnorm(z))
  # Add an asterisk if p-value < 0.10
  if (p_value < 0.10) {
    return(paste0(format(round(coef, 3), nsmall = 3), "*"))
  } else {
    return(format(round(coef, 3), nsmall = 3))
  }
}

add_asterisk_if_significant_by_row <- function(table, coef_rows, significance_level = 0.10) {
  # Loop over each specified coefficient row
  for (row in coef_rows) {
    # Loop over each cell in the specified row
    for (col in seq_len(ncol(table))) {
      # Try to convert the coefficient to numeric, ignoring non-numeric entries
      coef_value <- suppressWarnings(as.numeric(table[row, col]))
      
      # Proceed only if coef_value is numeric and not NA
      if (!is.na(coef_value)) {
        # Extract the standard error, removing parentheses and converting to numeric
        se_string <- table[row + 1, col]  # Get SE as a string
        se_value <- suppressWarnings(as.numeric(gsub("[()]", "", se_string)))  # Remove parentheses and convert to numeric
        
        # Check if the SE is valid before calculating significance
        if (!is.na(se_value)) {
          # Calculate z-score and p-value
          z_score <- abs(coef_value / se_value)
          p_value <- 2 * (1 - pnorm(z_score))
          
          # Add asterisk to coefficient if p-value < significance level
          if (p_value < significance_level) {
            table[row, col] <- paste0(format(coef_value, nsmall = 3), "*")
          }
        }
      }
    }
  }
  return(table)
}
 

```

## Data

```{r save}

df <- read_rds(here("data", "df.rds"))
df_dyad <- read_csv(here("data", "df_dyad.csv")) 

# original dataset taken from Stata
# df_stata <- read_dta(here("data", "model.dta"))
# df_stata_i <- read_dta(here("data", "individual.dta")) %>%
#   mutate(t2 = ifelse(team_size == 2, 1, 0),
#          t3 = ifelse(team_size == 3, 1, 0))

# d1 <- dplyr::select(df_dyad, AME, indiv1, indiv3, att, stats_i, topic_i, pbelief, t2, t3)
# d2 <- dplyr::select(df_stata_i, ame, indiv1, indiv3, att, stats_i, topic_i, pbelief, t2, t3)
# cor(d1, use = "pairwise.complete.obs")
# cor(d2, use = "pairwise.complete.obs")

```

## Models per Team

```{r amedesc}

team_ame_counts <- df %>%
  group_by(u_teamid) %>%
  summarize(count_AME = n()) # Count the number of AME values per u_teamid

overall_summary <- team_ame_counts %>%
  summarize(mean_count = mean(count_AME),
            sd_count = sd(count_AME))

overall_summary
```

## Summary Stats

```{r tbl1}
tbl1_team <- df %>%
  dplyr::select(u_teamid, index, AME, neg10s, pos10s, proindex, dindex, p12, p34, p56, group1, group2, group3, pbelief,  nmodel, 
	stats_brw, topic_brw, model_brw, team_size, peer_mean, quality, quality2, Hrej, pscore_Z) %>%
  group_by(u_teamid) %>%
  summarise_all(., mean, na.rm = T) %>%
  dplyr::select(-u_teamid) %>%
  ungroup()

tbl1_model <- df %>%
  dplyr::select(index, AME, neg10s, pos10s, group1, group2, group3, pbelief,  nmodel,  stats_brw, topic_brw, model_brw, team_size, pscore_Z, quality, quality2, Hrej, pscore)

tbl1_model_w <- df %>%
  dplyr::select(index, team_size, AME, neg10s, pos10s, nmodel)

tbl_5_model <- df %>% 
  dplyr::select(index, Scale, Stock, Flow, level_cyear, allavailable, w1996, w2006, w2016)
```

## Table 1

### T1 Model Level

```{r tbl1_model, warning = F}
n1 <- length(tbl1_model$index)
n2 <- length(tbl1_model$index[tbl1_model$index == 1])
n3 <- length(tbl1_model$index[tbl1_model$index == 2])
n4 <- length(tbl1_model$index[tbl1_model$index == 3])

mean1 <- tbl1_model %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "All teams")

mean2 <- tbl1_model %>%
  filter(index == 1) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Anti-imm")

mean3 <- tbl1_model %>%
  filter(index == 2) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Moderate")

mean4 <- tbl1_model %>%
  filter(index == 3) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Pro-imm")

Table_1_model <- bind_rows(mean1, mean2, mean3, mean4) %>%
  pivot_longer(cols = -sample, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = sample, values_from = Mean)

Table_1_model[,2:5] <- round(Table_1_model[,2:5], 3)

x <- as.data.frame(t(c("Num of teams",
                            length(tbl1_team$AME),
                            sum(tbl1_team$group1 == 1),
                            sum(tbl1_team$group2 == 1),
                            sum(tbl1_team$group3 == 1)
                            )))

colnames(x) <- colnames(Table_1_model)

Table_1_model <- rbind(x, Table_1_model)

Table_1_model$`All teams` <- as.numeric(Table_1_model$`All teams`)
Table_1_model$`Anti-imm` <- as.numeric(Table_1_model$`Anti-imm`)
Table_1_model$Moderate <- as.numeric(Table_1_model$Moderate)
Table_1_model$`Pro-imm` <- as.numeric(Table_1_model$`Pro-imm`)
  
Table_1_model[2:4,2] <- formatC(Table_1_model[2:4,2], format = "f", digits = 3)
Table_1_model[2:4,3] <- formatC(Table_1_model[2:4,3], format = "f", digits = 3)
Table_1_model[2:4,4] <- formatC(Table_1_model[2:4,4], format = "f", digits = 3)
Table_1_model[2:4,5] <- formatC(Table_1_model[2:4,5], format = "f", digits = 3)

# for visualizations (includes num of teams on top)
saveRDS(Table_1_model, here("results", "Table_1_model.rds"))

# for tables, removes num of teams on top
Table_1_model <- Table_1_model[2:20,]



```

##### T1 Model Level - Weighted

```{r tbl1_model_w, warning = F}
mean1 <- tbl1_model_w %>%
  summarise(across(-index, ~ weighted.mean(.x, w = 1 / nmodel, na.rm = TRUE))) %>%
  mutate(sample = "All teams")

mean2 <- tbl1_model_w %>%
  filter(index == 1) %>%
  summarise(across(-index, ~ weighted.mean(.x, w = 1 / nmodel, na.rm = TRUE))) %>%
  mutate(sample = "Anti-imm")

mean3 <- tbl1_model_w %>%
  filter(index == 2) %>%
  summarise(across(-index, ~ weighted.mean(.x, w = 1 / nmodel, na.rm = TRUE))) %>%
  mutate(sample = "Moderate")

mean4 <- tbl1_model_w %>%
  filter(index == 3) %>%
  summarise(across(-index, ~ weighted.mean(.x, w = 1 / nmodel, na.rm = TRUE))) %>%
  mutate(sample = "Pro-imm")

Table_1_model_w <- bind_rows(mean1, mean2, mean3, mean4) %>%
  pivot_longer(cols = -sample, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = sample, values_from = Mean)

Table_1_model_w[,2:5] <- round(Table_1_model_w[,2:5], 3)

Table_1_model_w <- as.data.frame(Table_1_model_w)

Table_1_model_w[1, 1:5] <- c("Num of teams",
                            length(tbl1_team$AME),
                            sum(tbl1_team$group1 == 1),
                            sum(tbl1_team$group2 == 1),
                            sum(tbl1_team$group3 == 1)
                            )

saveRDS(Table_1_model_w, here("results", "Table_1_model_w.rds"))
```

##### T1 Team Level

```{r tbl1_team}
nm1 <- length(tbl1_team$index)
nm2 <- length(tbl1_team$index[tbl1_team$index == 1])
nm3 <- length(tbl1_team$index[tbl1_team$index == 2])
nm4 <- length(tbl1_team$index[tbl1_team$index == 3])

mean1 <- tbl1_team %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "All teams")

mean2 <- tbl1_team %>%
  filter(index == 1) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Anti-imm")

mean3 <- tbl1_team %>%
  filter(index == 2) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Moderate")

mean4 <- tbl1_team %>%
  filter(index == 3) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Pro-imm")

Table_1_team <- bind_rows(mean1, mean2, mean3, mean4) %>%
  pivot_longer(cols = -sample, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = sample, values_from = Mean)

Table_1_team[,2:5] <- round(Table_1_team[,2:5], 3)



```

##### Build Table

```{r buildt1}

Table_1 <- as.data.frame(matrix(nrow = 15, ncol = 5))

Table_1[,1] <- c("Variable", "Mean AME", "% AME negative and significant", "% AME positive and significant", "Mean immigration sentiment", "% Anti-immigration teams", "% Moderate teams", "% Pro-immigration teams", "% Believe hypothesis", "Statistical skills (Z)", "Topic experience (Z)", "Peer score (Z)", "Team size", "N models", "N teams")

Table_1[1,2:5] <- c("All teams", "Anti-imm", "Moderate", "Pro-imm")

# Model-level summaries
Table_1[2:4,2:5] <- Table_1_model[1:3,2:5]

# Team-level summaries
Table_1_team <- subset(Table_1_team, Variable %in% c("proindex", "group1", "group2", "group3", "pbelief", "stats_brw", "topic_brw", "team_size"))

Table_1[c(5:11,13),2:5] <- Table_1_team[,2:5]

Table_1[12,2:5] <- Table_1_model[14,2:5]
Table_1[14,2:5] <- c(n1, n2, n3, n4)
Table_1[15,2:5] <- c(nm1, nm2, nm3, nm4)

kable(Table_1, col.names = c("","","","",""))

write_csv(Table_1, here("results", "TableS1.csv"))

```
#### Table X

Prior, no longer used

```{r tXb}

mean1 <- tbl_5_model %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "All teams")

mean2 <- tbl_5_model %>%
  filter(index == 1) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Anti-imm")

mean3 <- tbl_5_model %>%
  filter(index == 2) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Moderate")

mean4 <- tbl_5_model %>%
  filter(index == 3) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Pro-imm")

Table_5 <- bind_rows(mean1, mean2, mean3, mean4) %>%
  pivot_longer(cols = -sample, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = sample, values_from = Mean)

Table_5[,2:5] <- round(Table_5[,2:5], 3)

kable(Table_5, col.names = c("Design decision", "All teams", "Anti- immigration", "Moderate", "Pro- immigration"))
```


## Table 2. AME Model-Level

### Build Models

```{r t2rs}

m_1 <- lm.cluster(formula=AME ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_2 <- lm.cluster(formula=AME ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_3 <- lm.cluster(formula=AME ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_4 <- lm.cluster(formula=AME ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_5 <- lm.cluster(formula=AME ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_6 <- lm.cluster(formula=AME ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)


p_1 <- lm.cluster(formula=AME ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_2 <- lm.cluster(formula=AME ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_3 <- lm.cluster(formula=AME ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_4 <- lm.cluster(formula=AME ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_5 <- lm.cluster(formula=AME ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_6 <- lm.cluster(formula=AME ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

null_m <- lm.cluster(formula=AME ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

null_p <- lm.cluster(formula=AME ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

# re-run as lm's to get fit stats
source(here("code", "Sub", "t2_fit.R"))

```

### Build Table

```{r t2r}

# Create the Table_2 dataframe and populate with regression results
Table_2 <- as.data.frame(matrix(nrow = 32, ncol = 8))
Table_2[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")
Table_2[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

# Apply the function for each set of coefficients and standard errors
Table_2[c(6,8),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_m$lm_res$coefficients[i], summary(null_m)[i,2]))
Table_2[c(7,9),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_m)[2:3,2]),3), nsmall = 3))

Table_2[c(4,6,8),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_1$lm_res$coefficients[i], summary(m_1)[i,2]))
Table_2[c(5,7,9),3] <- sprintf("(%s)", format(round(as.numeric(summary(m_1)[2:4,2]),3), nsmall = 3))

Table_2[c(4,10,6,8),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_2$lm_res$coefficients[i], summary(m_2)[i,2]))
Table_2[c(5,11,7,9),4] <- sprintf("(%s)", format(round(as.numeric(summary(m_2)[2:5,2]),3), nsmall = 3))

Table_2[c(2,4,6,8),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_3$lm_res$coefficients[i], summary(m_3)[i,2]))
Table_2[c(3,5,7,9),5] <- sprintf("(%s)", format(round(as.numeric(summary(m_3)[2:5,2]),3), nsmall = 3))

Table_2[c(2,4,6,8,10),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(m_4$lm_res$coefficients[i], summary(m_4)[i,2]))
Table_2[c(3,5,7,9,11),6] <- sprintf("(%s)", format(round(as.numeric(summary(m_4)[c(2,3,5,6,4),2]),3), nsmall = 3))

Table_2[c(12,6,8),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_5$lm_res$coefficients[i], summary(m_5)[i,2]))
Table_2[c(13,7,9),7] <- sprintf("(%s)", format(round(as.numeric(summary(m_5)[2:4,2]),3), nsmall = 3))

Table_2[c(12,10,6,8),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_6$lm_res$coefficients[i], summary(m_6)[i,2]))
Table_2[c(13,11,7,9),8] <- sprintf("(%s)", format(round(as.numeric(summary(m_6)[2:5,2]),3), nsmall = 3))

# Add R-squared, Log-Likelihood, and AIC values
Table_2[16,2:8] <- c(r2ext(null_m), r2ext(m_1), r2ext(m_2), r2ext(m_3), r2ext(m_4), r2ext(m_5), r2ext(m_6))
Table_2[14,2:8] <- round(c(logLik((null_ml)), logLik(m_1l), logLik(m_2l), logLik(m_3l), logLik(m_4l), logLik(m_5l), logLik(m_6l)),2)
Table_2[15,2:8] <- round(c(AIC((null_ml)), AIC(m_1l), AIC(m_2l), AIC(m_3l), AIC(m_4l), AIC(m_5l), AIC(m_6l)),2)

# p_ models with add_asterisk_if_significant_cluster function
Table_2[c(22,24),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_p$lm_res$coefficients[i], summary(null_p)[i, 2]))
Table_2[c(23,25),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_p)[2:3, 2]), 3), nsmall = 3))

Table_2[c(20,22,24),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_1$lm_res$coefficients[i], summary(p_1)[i, 2]))
Table_2[c(21,23,25),3] <- sprintf("(%s)", format(round(as.numeric(summary(p_1)[2:4, 2]), 3), nsmall = 3))

Table_2[c(20,26,22,24),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_2$lm_res$coefficients[i], summary(p_2)[i, 2]))
Table_2[c(21,27,23,25),4] <- sprintf("(%s)", format(round(as.numeric(summary(p_2)[2:5, 2]), 3), nsmall = 3))

Table_2[c(18,20,22,24),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_3$lm_res$coefficients[i], summary(p_3)[i, 2]))
Table_2[c(19,21,23,25),5] <- sprintf("(%s)", format(round(as.numeric(summary(p_3)[2:5, 2]), 3), nsmall = 3))

Table_2[c(18,20,22,24,26),6] <- sapply(c(2, 3, 5, 6, 4), function(i) add_asterisk_if_significant_cluster(p_4$lm_res$coefficients[i], summary(p_4)[i, 2]))
Table_2[c(19,21,23,25,27),6] <- sprintf("(%s)", format(round(as.numeric(summary(p_4)[c(2, 3, 5, 6, 4), 2]), 3), nsmall = 3))

Table_2[c(28,22,24),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_5$lm_res$coefficients[i], summary(p_5)[i, 2]))
Table_2[c(29,23,25),7] <- sprintf("(%s)", format(round(as.numeric(summary(p_5)[2:4, 2]), 3), nsmall = 3))

Table_2[c(28,26,22,24),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_6$lm_res$coefficients[i], summary(p_6)[i, 2]))
Table_2[c(29,27,23,25),8] <- sprintf("(%s)", format(round(as.numeric(summary(p_6)[2:5, 2]), 3), nsmall = 3))

# Add R-squared, Log-Likelihood, and AIC values
Table_2[32,2:8] <- c(r2ext(null_p), r2ext(p_1), r2ext(p_2), r2ext(p_3), r2ext(p_4), r2ext(p_5), r2ext(p_6))
Table_2[30,2:8] <- round(c(logLik((null_pl)), logLik(p_1l), logLik(p_2l), logLik(p_3l), logLik(p_4l), logLik(p_5l), logLik(p_6l)), 2)
Table_2[31,2:8] <- round(c(AIC((null_pl)), AIC(p_1l), AIC(p_2l), AIC(p_3l), AIC(p_4l), AIC(p_5l), AIC(p_6l)), 2)


# Replace NA values with an empty string
Table_2[is.na(Table_2)] <- ""

# Write the table to CSV
write.csv(Table_2, here::here("results", "TableS2.csv"), row.names = FALSE)

# Display the table
kable(Table_2, col.names = c("","","","","","","",""))


```

## Table 3. AME. Indiv-Model Dyads

Individual level models

### Build Models


```{r t3}

m_1d <- lm.cluster(formula=AME ~ indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_2d <- lm.cluster(formula=AME ~ indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_3d <- lm.cluster(formula=AME ~ indiv1 + indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_4d <- lm.cluster(formula=AME ~ indiv1 + indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_5d <- lm.cluster(formula=AME ~ att + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_6d <- lm.cluster(formula=AME ~ att + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)


p_1d <- lm.cluster(formula=AME ~ indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_2d <- lm.cluster(formula=AME ~ indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_3d <- lm.cluster(formula=AME ~ indiv1 + indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_4d <- lm.cluster(formula=AME ~ indiv1 + indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_5d <- lm.cluster(formula=AME ~ att + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_6d <- lm.cluster(formula=AME ~ att + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

null_md <- lm.cluster(formula=AME ~ stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

null_pd <- lm.cluster(formula=AME ~ stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

# re-run as lm's to get fit stats
source(here("code", "Sub", "t3_fit.R"))

#nobs(m_1ld)
```

### Build Table

```{r t3b}

# Define the Table_3 structure
Table_3 <- as.data.frame(matrix(nrow = 32, ncol = 8))
Table_3[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")
Table_3[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

# m_ models
Table_3[c(6,8),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_md$lm_res$coefficients[i], summary(null_md)[i, 2]))
Table_3[c(7,9),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_md)[2:3, 2]), 3), nsmall = 3))

Table_3[c(4,6,8),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_1d$lm_res$coefficients[i], summary(m_1d)[i, 2]))
Table_3[c(5,7,9),3] <- sprintf("(%s)", format(round(as.numeric(summary(m_1d)[2:4, 2]), 3), nsmall = 3))

Table_3[c(4,10,6,8),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_2d$lm_res$coefficients[i], summary(m_2d)[i, 2]))
Table_3[c(5,11,7,9),4] <- sprintf("(%s)", format(round(as.numeric(summary(m_2d)[2:5, 2]), 3), nsmall = 3))

Table_3[c(2,4,6,8),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_3d$lm_res$coefficients[i], summary(m_3d)[i, 2]))
Table_3[c(3,5,7,9),5] <- sprintf("(%s)", format(round(as.numeric(summary(m_3d)[2:5, 2]), 3), nsmall = 3))

Table_3[c(2,4,6,8,10),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(m_4d$lm_res$coefficients[i], summary(m_4d)[i, 2]))
Table_3[c(3,5,7,9,11),6] <- sprintf("(%s)", format(round(as.numeric(summary(m_4d)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_3[c(12,6,8),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_5d$lm_res$coefficients[i], summary(m_5d)[i, 2]))
Table_3[c(13,7,9),7] <- sprintf("(%s)", format(round(as.numeric(summary(m_5d)[2:4, 2]), 3), nsmall = 3))

Table_3[c(12,10,6,8),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_6d$lm_res$coefficients[i], summary(m_6d)[i, 2]))
Table_3[c(13,11,7,9),8] <- sprintf("(%s)", format(round(as.numeric(summary(m_6d)[2:5, 2]), 3), nsmall = 3))

# R-squared, Log-Likelihood, and AIC for m_ models
Table_3[16,2:8] <- c(r2ext(null_md), r2ext(m_1d), r2ext(m_2d), r2ext(m_3d), r2ext(m_4d), r2ext(m_5d), r2ext(m_6d))
Table_3[14,2:8] <- round(c(logLik(null_mld), logLik(m_1ld), logLik(m_2ld), logLik(m_3ld), logLik(m_4ld), logLik(m_5ld), logLik(m_6ld)), 2)
Table_3[15,2:8] <- round(c(AIC(null_mld), AIC(m_1ld), AIC(m_2ld), AIC(m_3ld), AIC(m_4ld), AIC(m_5ld), AIC(m_6ld)), 2)

# p_ models
Table_3[c(22,24),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_pd$lm_res$coefficients[i], summary(null_pd)[i, 2]))
Table_3[c(23,25),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_pd)[2:3, 2]), 3), nsmall = 3))

Table_3[c(20,22,24),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_1d$lm_res$coefficients[i], summary(p_1d)[i, 2]))
Table_3[c(21,23,25),3] <- sprintf("(%s)", format(round(as.numeric(summary(p_1d)[2:4, 2]), 3), nsmall = 3))

Table_3[c(20,26,22,24),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_2d$lm_res$coefficients[i], summary(p_2d)[i, 2]))
Table_3[c(21,27,23,25),4] <- sprintf("(%s)", format(round(as.numeric(summary(p_2d)[2:5, 2]), 3), nsmall = 3))

Table_3[c(18,20,22,24),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_3d$lm_res$coefficients[i], summary(p_3d)[i, 2]))
Table_3[c(19,21,23,25),5] <- sprintf("(%s)", format(round(as.numeric(summary(p_3d)[2:5, 2]), 3), nsmall = 3))

Table_3[c(18,20,22,24,26),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(p_4d$lm_res$coefficients[i], summary(p_4d)[i, 2]))
Table_3[c(19,21,23,25,27),6] <- sprintf("(%s)", format(round(as.numeric(summary(p_4d)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_3[c(28,22,24),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_5d$lm_res$coefficients[i], summary(p_5d)[i, 2]))
Table_3[c(29,23,25),7] <- sprintf("(%s)", format(round(as.numeric(summary(p_5d)[2:4, 2]), 3), nsmall = 3))

Table_3[c(28,26,22,24),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_6d$lm_res$coefficients[i], summary(p_6d)[i, 2]))
Table_3[c(29,27,23,25),8] <- sprintf("(%s)", format(round(as.numeric(summary(p_6d)[2:5, 2]), 3), nsmall = 3))

# R-squared, Log-Likelihood, and AIC for p_ models
Table_3[32,2:8] <- c(r2ext(null_pd), r2ext(p_1d), r2ext(p_2d), r2ext(p_3d), r2ext(p_4d), r2ext(p_5d), r2ext(p_6d))

Table_3[30,2:8] <- round(c(logLik(null_pld), logLik(p_1ld), logLik(p_2ld), logLik(p_3ld), logLik(p_4ld), logLik(p_5ld), logLik(p_6ld)))

Table_3[31,2:8] <- round(c(AIC((null_pld)), AIC(p_1ld), AIC(p_2ld), AIC(p_3ld), AIC(p_4ld), AIC(p_5ld), AIC(p_6ld)),2)

Table_3[is.na(Table_3)] <- ""

write.csv(Table_3, here::here("results", "TableS3.csv"), row.names = F)

kable(Table_3, col.names = c("","","","","","","",""))


```


## Table 4. Robustness

pindex = percent of team that is pro
p34 = percent of team that is moderate
counter2 = unique degree variable

### Build Models

```{r t4}

r11 <- m_5
r12 <- lm.cluster(formula=AME ~ pindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r13 <- m_1
r14 <- lm.cluster(formula=AME ~ p34 + pindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r15 <- lm.cluster(formula=AME ~ group2 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

r21 <- lm.cluster(formula=AME ~ pro_index + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r22 <- lm.cluster(formula=AME ~ pindex + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r23 <- lm.cluster(formula=AME ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r24 <- lm.cluster(formula=AME ~ p34 + pindex + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r25 <- lm.cluster(formula=AME ~ group2 + group3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

r31 <- lm.cluster(formula=AME ~ pro_index + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r32 <- lm.cluster(formula=AME ~ pindex + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r33 <- lm.cluster(formula=AME ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r34 <- lm.cluster(formula=AME ~ p34 + pindex + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = 1/df$nmodel, cluster = "u_teamid", data = df)
r35 <- lm.cluster(formula=AME ~ group2 + group3 + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

p11 <- p_5
p12 <- lm.cluster(formula=AME ~ pindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p13 <- p_1
p14 <- lm.cluster(formula=AME ~ p34 + pindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p15 <- lm.cluster(formula=AME ~ group2 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p21 <- lm.cluster(formula=AME ~ pro_index + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p22 <- lm.cluster(formula=AME ~ pindex + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p23 <- lm.cluster(formula=AME ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p24 <- lm.cluster(formula=AME ~ p34 + pindex + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p25 <- lm.cluster(formula=AME ~ group2 + group3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree1), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p31 <- lm.cluster(formula=AME ~ pro_index + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p32 <- lm.cluster(formula=AME ~ pindex + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p33 <- lm.cluster(formula=AME ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p34 <- lm.cluster(formula=AME ~ p34 + pindex + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)
p35 <- lm.cluster(formula=AME ~ group2 + group3 + stats_brw + topic_brw + t2 + t3 + factor(counter2), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

```


### Build Table

```{r t4b}

Table_4 <- as.data.frame(matrix(nrow = 35, ncol = 4))

Table_4[1,] <- c("Alternative coding of ideology", "(1) Baseline degree coding", "(2) First author discipline", "(3) All possible discipline combinations")

Table_4[2:35, 1] <- c("A. Weighted by number of models per team", "(1) Mean immigration sentiment index", "", "(2) % of team that is pro-immigration", "", "(3) Pro-immigration team", "", "4. Alternative grouping:", "% of team that is moderate", "", "% of team that is pro-immigration", "", "Baseline with anti- as reference category:", "Moderate team", "", "Pro-immigration team", "", "", "B. Additionally weighted by peer review scores", "(1) Mean immigration sentiment index", "", "(2) % of team that is pro-immigration", "", "(3) Pro-immigration team", "", "4. Alternative grouping:", "% of team that is moderate", "", "% of team that is pro-immigration", "", "Baseline with anti- as reference category:", "Moderate team", "", "Pro-immigration team") 

# Define the rows where coefficients and standard errors should go
coef_rows <- c(3,5,7,10,12,15,17,21,23,25,28,30,33,35)  # Rows 2, 4, 6, 8, 10 for coefficients
se_rows <- c(4,6,8,11,13,16,18,22,24,26,29,31,34,36)    # Rows 3, 5, 7, 9, 11 for standard errors

# List of lm.cluster objects
lm_objects <- list(r11, r12, r13, r14, r14, r15, r15,
                   p11, p12, p13, p14, p14, p15, p15
                   )
r <- c(2,2,2,2,3,2,3,2,2,2,2,3,2,3)

# column 2
for (i in seq_along(lm_objects)) {
  # Extract the coefficient (second item, first after intercept) and standard error
  coef_value <- lm_objects[[i]]$lm_res$coefficients[r[i]]
  se_value <- as.numeric(summary(lm_objects[[i]])[r[i], 2])
  
  # Format and place into the specified rows in Table_4
  Table_4[coef_rows[i], 2] <- format(round(coef_value, 3), nsmall = 3)
  Table_4[se_rows[i], 2] <- sprintf("(%s)", format(round(se_value, 3), nsmall = 3))
}

# column 3
lm_objects <- list(r21, r22, r23, r24, r24, r25, r25,
                   p21, p22, p23, p24, p24, p25, p25)

for (i in seq_along(lm_objects)) {
  # Extract the coefficient (second item, first after intercept) and standard error
  coef_value <- lm_objects[[i]]$lm_res$coefficients[r[i]]
  se_value <- as.numeric(summary(lm_objects[[i]])[r[i], 2])
  
  # Format and place into the specified rows in Table_4
  Table_4[coef_rows[i], 3] <- format(round(coef_value, 3), nsmall = 3)
  Table_4[se_rows[i], 3] <- sprintf("(%s)", format(round(se_value, 3), nsmall = 3))
}

# column 4
lm_objects <- list(p31, p32, p33, p34, p34, p35, p35,
                   r31, r32, r33, r34, r34, r35, r35)


for (i in seq_along(lm_objects)) {
  # Extract the coefficient (second item, first after intercept) and standard error
  coef_value <- lm_objects[[i]]$lm_res$coefficients[r[i]]
  se_value <- as.numeric(summary(lm_objects[[i]])[r[i], 2])
  
  # Format and place into the specified rows in Table_4
  Table_4[coef_rows[i], 4] <- format(round(coef_value, 3), nsmall = 3)
  Table_4[se_rows[i], 4] <- sprintf("(%s)", format(round(se_value, 3), nsmall = 3))
}
  

Table_4 <- add_asterisk_if_significant_by_row(Table_4, coef_rows = coef_rows, significance_level = 0.1001) # to account for rounding error

Table_4[is.na(Table_4)] <- ""

write.csv(Table_4, here::here("results", "TableS4.csv"), row.names = F)

kable(Table_4, col.names = c("","","",""))

```



## Table 5. Neg Extreme. Model-level


### Build Models

```{r t5}

m_1n <- lm.cluster(formula=neg10s ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_2n <- lm.cluster(formula=neg10s ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_3n <- lm.cluster(formula=neg10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_4n <- lm.cluster(formula=neg10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_5n <- lm.cluster(formula=neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_6n <- lm.cluster(formula=neg10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)


p_1n <- lm.cluster(formula=neg10s ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_2n <- lm.cluster(formula=neg10s ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_3n <- lm.cluster(formula=neg10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_4n <- lm.cluster(formula=neg10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_5n <- lm.cluster(formula=neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_6n <- lm.cluster(formula=neg10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

null_mn <- lm.cluster(formula=neg10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

null_pn <- lm.cluster(formula=neg10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

# re-run as lm's to get fit stats
source(here("code", "Sub", "t4_fit.R"))

```

### Build Table

```{r t5b}

Table_5 <- as.data.frame(matrix(nrow = 32, ncol = 8))

Table_5[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")

Table_5[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

#m_ models
# Apply the function to add asterisk for significance in Table_5

Table_5[c(6,8),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_mn$lm_res$coefficients[i], summary(null_mn)[i, 2]))
Table_5[c(7,9),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_mn)[2:3, 2]), 3), nsmall = 3))

Table_5[c(4,6,8),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_1n$lm_res$coefficients[i], summary(m_1n)[i, 2]))
Table_5[c(5,7,9),3] <- sprintf("(%s)", format(round(as.numeric(summary(m_1n)[2:4, 2]), 3), nsmall = 3))

Table_5[c(4,10,6,8),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_2n$lm_res$coefficients[i], summary(m_2n)[i, 2]))
Table_5[c(5,11,7,9),4] <- sprintf("(%s)", format(round(as.numeric(summary(m_2n)[2:5, 2]), 3), nsmall = 3))

Table_5[c(2,4,6,8),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_3n$lm_res$coefficients[i], summary(m_3n)[i, 2]))
Table_5[c(3,5,7,9),5] <- sprintf("(%s)", format(round(as.numeric(summary(m_3n)[2:5, 2]), 3), nsmall = 3))

Table_5[c(2,4,6,8,10),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(m_4n$lm_res$coefficients[i], summary(m_4n)[i, 2]))
Table_5[c(3,5,7,9,11),6] <- sprintf("(%s)", format(round(as.numeric(summary(m_4n)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_5[c(12,6,8),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_5n$lm_res$coefficients[i], summary(m_5n)[i, 2]))
Table_5[c(13,7,9),7] <- sprintf("(%s)", format(round(as.numeric(summary(m_5n)[2:4, 2]), 3), nsmall = 3))

Table_5[c(12,10,6,8),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_6n$lm_res$coefficients[i], summary(m_6n)[i, 2]))
Table_5[c(13,11,7,9),8] <- sprintf("(%s)", format(round(as.numeric(summary(m_6n)[2:5, 2]), 3), nsmall = 3))



Table_5[16,2:8] <- c(r2ext(null_mn), r2ext(m_1n), r2ext(m_2n), r2ext(m_3n), r2ext(m_4n), r2ext(m_5n), r2ext(m_6n))

Table_5[14,2:8] <- round(c(logLik((null_mln)), logLik(m_1ln), logLik(m_2ln), logLik(m_3ln), logLik(m_4ln), logLik(m_5ln), logLik(m_6ln)),2)

Table_5[15,2:8] <- round(c(AIC((null_mln)), AIC(m_1ln), AIC(m_2ln), AIC(m_3ln), AIC(m_4ln), AIC(m_5ln), AIC(m_6ln)),2)

#p_ models
# Apply the function to add asterisk for significance in Table_5 for pn models

Table_5[c(22,24),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_pn$lm_res$coefficients[i], summary(null_pn)[i, 2]))
Table_5[c(23,25),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_pn)[2:3, 2]), 3), nsmall = 3))

Table_5[c(20,22,24),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_1n$lm_res$coefficients[i], summary(p_1n)[i, 2]))
Table_5[c(21,23,25),3] <- sprintf("(%s)", format(round(as.numeric(summary(p_1n)[2:4, 2]), 3), nsmall = 3))

Table_5[c(20,26,22,24),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_2n$lm_res$coefficients[i], summary(p_2n)[i, 2]))
Table_5[c(21,27,23,25),4] <- sprintf("(%s)", format(round(as.numeric(summary(p_2n)[2:5, 2]), 3), nsmall = 3))

Table_5[c(18,20,22,24),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_3n$lm_res$coefficients[i], summary(p_3n)[i, 2]))
Table_5[c(19,21,23,25),5] <- sprintf("(%s)", format(round(as.numeric(summary(p_3n)[2:5, 2]), 3), nsmall = 3))

Table_5[c(18,20,22,24,26),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(p_4n$lm_res$coefficients[i], summary(p_4n)[i, 2]))
Table_5[c(19,21,23,25,27),6] <- sprintf("(%s)", format(round(as.numeric(summary(p_4n)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_5[c(28,22,24),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_5n$lm_res$coefficients[i], summary(p_5n)[i, 2]))
Table_5[c(29,23,25),7] <- sprintf("(%s)", format(round(as.numeric(summary(p_5n)[2:4, 2]), 3), nsmall = 3))

Table_5[c(28,26,22,24),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_6n$lm_res$coefficients[i], summary(p_6n)[i, 2]))
Table_5[c(29,27,23,25),8] <- sprintf("(%s)", format(round(as.numeric(summary(p_6n)[2:5, 2]), 3), nsmall = 3))


Table_5[32,2:8] <- c(r2ext(null_pn), r2ext(p_1n), r2ext(p_2n), r2ext(p_3n), r2ext(p_4n), r2ext(p_5n), r2ext(p_6n))

Table_5[30,2:8] <- round(c(logLik((null_pln)), logLik(p_1ln), logLik(p_2ln), logLik(p_3ln), logLik(p_4ln), logLik(p_5ln), logLik(p_6ln)),2)

Table_5[31,2:8] <- round(c(AIC((null_pln)), AIC(p_1ln), AIC(p_2ln), AIC(p_3ln), AIC(p_4ln), AIC(p_5ln), AIC(p_6ln)),2)

Table_5[is.na(Table_5)] <- ""

write.csv(Table_5, here::here("results", "TableS5.csv"), row.names = F)

kable(Table_5, col.names = c("","","","","","","",""))


```


## Table 6. Neg extreme. Individual-model dyads

Individual level models

### Build Models


```{r t6}

m_1dn <- lm.cluster(formula=neg10s ~ indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_2dn <- lm.cluster(formula=neg10s ~ indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_3dn <- lm.cluster(formula=neg10s ~ indiv1 + indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_4dn <- lm.cluster(formula=neg10s ~ indiv1 + indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_5dn <- lm.cluster(formula=neg10s ~ att + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_6dn <- lm.cluster(formula=neg10s ~ att + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)


p_1dn <- lm.cluster(formula=neg10s ~ indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_2dn <- lm.cluster(formula=neg10s ~ indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_3dn <- lm.cluster(formula=neg10s ~ indiv1 + indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_4dn <- lm.cluster(formula=neg10s ~ indiv1 + indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_5dn <- lm.cluster(formula=neg10s ~ att + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_6dn <- lm.cluster(formula=neg10s ~ att + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

null_mdn <- lm.cluster(formula=neg10s ~ stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

null_pdn <- lm.cluster(formula=neg10s ~ stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

# re-run as lm's to get fit stats
source(here("code", "Sub", "t5_fit.R"))

#nobs(m_1ldn)
```

### Build Table

```{r t6b}

Table_6 <- as.data.frame(matrix(nrow = 32, ncol = 8))

Table_6[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")

Table_6[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

#m_ models
Table_6[c(6,8),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_mdn$lm_res$coefficients[i], summary(null_mdn)[i, 2]))
Table_6[c(7,9),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_mdn)[2:3, 2]), 3), nsmall = 3))

Table_6[c(4,6,8),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_1dn$lm_res$coefficients[i], summary(m_1dn)[i, 2]))
Table_6[c(5,7,9),3] <- sprintf("(%s)", format(round(as.numeric(summary(m_1dn)[2:4, 2]), 3), nsmall = 3))

Table_6[c(4,10,6,8),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_2dn$lm_res$coefficients[i], summary(m_2dn)[i, 2]))
Table_6[c(5,11,7,9),4] <- sprintf("(%s)", format(round(as.numeric(summary(m_2dn)[2:5, 2]), 3), nsmall = 3))

Table_6[c(2,4,6,8),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_3dn$lm_res$coefficients[i], summary(m_3dn)[i, 2]))
Table_6[c(3,5,7,9),5] <- sprintf("(%s)", format(round(as.numeric(summary(m_3dn)[2:5, 2]), 3), nsmall = 3))

Table_6[c(2,4,6,8,10),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(m_4dn$lm_res$coefficients[i], summary(m_4dn)[i, 2]))
Table_6[c(3,5,7,9,11),6] <- sprintf("(%s)", format(round(as.numeric(summary(m_4dn)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_6[c(12,6,8),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_5dn$lm_res$coefficients[i], summary(m_5dn)[i, 2]))
Table_6[c(13,7,9),7] <- sprintf("(%s)", format(round(as.numeric(summary(m_5dn)[2:4, 2]), 3), nsmall = 3))

Table_6[c(12,10,6,8),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_6dn$lm_res$coefficients[i], summary(m_6dn)[i, 2]))
Table_6[c(13,11,7,9),8] <- sprintf("(%s)", format(round(as.numeric(summary(m_6dn)[2:5, 2]), 3), nsmall = 3))


Table_6[16,2:8] <- c(r2ext(null_mdn), r2ext(m_1dn), r2ext(m_2dn), r2ext(m_3dn), r2ext(m_4dn), r2ext(m_5dn), r2ext(m_6dn))

Table_6[14,2:8] <- round(c(logLik((null_mldn)), logLik(m_1ldn), logLik(m_2ldn), logLik(m_3ldn), logLik(m_4ldn), logLik(m_5ldn), logLik(m_6ldn)),2)

Table_6[15,2:8] <- round(c(AIC((null_mldn)), AIC(m_1ldn), AIC(m_2ldn), AIC(m_3ldn), AIC(m_4ldn), AIC(m_5ldn), AIC(m_6ldn)),2)

#p_ models
Table_6[c(22,24),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_pdn$lm_res$coefficients[i], summary(null_pdn)[i, 2]))
Table_6[c(23,25),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_pdn)[2:3, 2]), 3), nsmall = 3))

Table_6[c(20,22,24),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_1dn$lm_res$coefficients[i], summary(p_1dn)[i, 2]))
Table_6[c(21,23,25),3] <- sprintf("(%s)", format(round(as.numeric(summary(p_1dn)[2:4, 2]), 3), nsmall = 3))

Table_6[c(20,26,22,24),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_2dn$lm_res$coefficients[i], summary(p_2dn)[i, 2]))
Table_6[c(21,27,23,25),4] <- sprintf("(%s)", format(round(as.numeric(summary(p_2dn)[2:5, 2]), 3), nsmall = 3))

Table_6[c(18,20,22,24),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_3dn$lm_res$coefficients[i], summary(p_3dn)[i, 2]))
Table_6[c(19,21,23,25),5] <- sprintf("(%s)", format(round(as.numeric(summary(p_3dn)[2:5, 2]), 3), nsmall = 3))

Table_6[c(18,20,22,24,26),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(p_4dn$lm_res$coefficients[i], summary(p_4dn)[i, 2]))
Table_6[c(19,21,23,25,27),6] <- sprintf("(%s)", format(round(as.numeric(summary(p_4dn)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_6[c(28,22,24),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_5dn$lm_res$coefficients[i], summary(p_5dn)[i, 2]))
Table_6[c(29,23,25),7] <- sprintf("(%s)", format(round(as.numeric(summary(p_5dn)[2:4, 2]), 3), nsmall = 3))

Table_6[c(28,26,22,24),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_6dn$lm_res$coefficients[i], summary(p_6dn)[i, 2]))
Table_6[c(29,27,23,25),8] <- sprintf("(%s)", format(round(as.numeric(summary(p_6dn)[2:5, 2]), 3), nsmall = 3))

Table_6[32,2:8] <- c(r2ext(null_pdn), r2ext(p_1dn), r2ext(p_2dn), r2ext(p_3dn), r2ext(p_4dn), r2ext(p_5dn), r2ext(p_6dn))

Table_6[30,2:8] <- round(c(logLik((null_pldn)), logLik(p_1ldn), logLik(p_2ldn), logLik(p_3ldn), logLik(p_4ldn), logLik(p_5ldn), logLik(p_6ldn)),2)

Table_6[31,2:8] <- round(c(AIC((null_pldn)), AIC(p_1ldn), AIC(p_2ldn), AIC(p_3ldn), AIC(p_4ldn), AIC(p_5ldn), AIC(p_6ldn)),2)

Table_6[is.na(Table_6)] <- ""

write.csv(Table_6, here::here("results", "TableS6.csv"), row.names = F)

kable(Table_6, col.names = c("","","","","","","",""))


```


## Table 7. Pos extreme. Model-level

### Build Models

```{r t7}

m_1p <- lm.cluster(formula=pos10s ~ group1 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_2p <- lm.cluster(formula=pos10s ~ group1 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_3p <- lm.cluster(formula=pos10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_4p <- lm.cluster(formula=pos10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_5p <- lm.cluster(formula=pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_6p <- lm.cluster(formula=pos10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)


p_1p <- lm.cluster(formula=pos10s ~ group1 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_2p <- lm.cluster(formula=pos10s ~ group1 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_3p <- lm.cluster(formula=pos10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_4p <- lm.cluster(formula=pos10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_5p <- lm.cluster(formula=pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

p_6p <- lm.cluster(formula=pos10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

null_mp <- lm.cluster(formula=pos10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

null_pp <- lm.cluster(formula=pos10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore_1/df$nmodel, cluster = "u_teamid", data = df)

# re-run as lm's to get fit stats
source(here("code", "Sub", "t6_fit.R"))

```


### Build Table

```{r t7b}

Table_7 <- as.data.frame(matrix(nrow = 32, ncol = 8))

Table_7[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")

Table_7[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

#m_ models
Table_7[c(6,8),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_mp$lm_res$coefficients[i], summary(null_mp)[i, 2]))
Table_7[c(7,9),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_mp)[2:3, 2]), 3), nsmall = 3))

Table_7[c(2,6,8),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_1p$lm_res$coefficients[i], summary(m_1p)[i, 2]))
Table_7[c(3,7,9),3] <- sprintf("(%s)", format(round(as.numeric(summary(m_1p)[2:4, 2]), 3), nsmall = 3))

Table_7[c(2,10,6,8),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_2p$lm_res$coefficients[i], summary(m_2p)[i, 2]))
Table_7[c(3,11,7,9),4] <- sprintf("(%s)", format(round(as.numeric(summary(m_2p)[2:5, 2]), 3), nsmall = 3))

Table_7[c(2,4,6,8),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_3p$lm_res$coefficients[i], summary(m_3p)[i, 2]))
Table_7[c(3,5,7,9),5] <- sprintf("(%s)", format(round(as.numeric(summary(m_3p)[2:5, 2]), 3), nsmall = 3))

Table_7[c(2,4,6,8,10),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(m_4p$lm_res$coefficients[i], summary(m_4p)[i, 2]))
Table_7[c(3,5,7,9,11),6] <- sprintf("(%s)", format(round(as.numeric(summary(m_4p)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_7[c(12,6,8),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_5p$lm_res$coefficients[i], summary(m_5p)[i, 2]))
Table_7[c(13,7,9),7] <- sprintf("(%s)", format(round(as.numeric(summary(m_5p)[2:4, 2]), 3), nsmall = 3))

Table_7[c(12,10,6,8),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_6p$lm_res$coefficients[i], summary(m_6p)[i, 2]))
Table_7[c(13,11,7,9),8] <- sprintf("(%s)", format(round(as.numeric(summary(m_6p)[2:5, 2]), 3), nsmall = 3))



Table_7[16,2:8] <- c(r2ext(null_mp), r2ext(m_1p), r2ext(m_2p), r2ext(m_3p), r2ext(m_4p), r2ext(m_5p), r2ext(m_6p))

Table_7[14,2:8] <- round(c(logLik((null_mlp)), logLik(m_1lp), logLik(m_2lp), logLik(m_3lp), logLik(m_4lp), logLik(m_5lp), logLik(m_6lp)),2)

Table_7[15,2:8] <- round(c(AIC((null_mlp)), AIC(m_1lp), AIC(m_2lp), AIC(m_3lp), AIC(m_4lp), AIC(m_5lp), AIC(m_6lp)),2)

#p_ models
Table_7[c(22,24),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_pp$lm_res$coefficients[i], summary(null_pp)[i, 2]))
Table_7[c(23,25),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_pp)[2:3, 2]), 3), nsmall = 3))

Table_7[c(18,22,24),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_1p$lm_res$coefficients[i], summary(p_1p)[i, 2]))
Table_7[c(19,23,25),3] <- sprintf("(%s)", format(round(as.numeric(summary(p_1p)[2:4, 2]), 3), nsmall = 3))

Table_7[c(18,26,22,24),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_2p$lm_res$coefficients[i], summary(p_2p)[i, 2]))
Table_7[c(19,27,23,25),4] <- sprintf("(%s)", format(round(as.numeric(summary(p_2p)[2:5, 2]), 3), nsmall = 3))

Table_7[c(18,20,22,24),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_3p$lm_res$coefficients[i], summary(p_3p)[i, 2]))
Table_7[c(19,21,23,25),5] <- sprintf("(%s)", format(round(as.numeric(summary(p_3p)[2:5, 2]), 3), nsmall = 3))

Table_7[c(18,20,22,24,26),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(p_4p$lm_res$coefficients[i], summary(p_4p)[i, 2]))
Table_7[c(19,21,23,25,27),6] <- sprintf("(%s)", format(round(as.numeric(summary(p_4p)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_7[c(28,22,24),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_5p$lm_res$coefficients[i], summary(p_5p)[i, 2]))
Table_7[c(29,23,25),7] <- sprintf("(%s)", format(round(as.numeric(summary(p_5p)[2:4, 2]), 3), nsmall = 3))

Table_7[c(28,26,22,24),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_6p$lm_res$coefficients[i], summary(p_6p)[i, 2]))
Table_7[c(29,27,23,25),8] <- sprintf("(%s)", format(round(as.numeric(summary(p_6p)[2:5, 2]), 3), nsmall = 3))

Table_7[32,2:8] <- c(r2ext(null_pp), r2ext(p_1p), r2ext(p_2p), r2ext(p_3p), r2ext(p_4p), r2ext(p_5p), r2ext(p_6p))

Table_7[30,2:8] <- round(c(logLik((null_plp)), logLik(p_1lp), logLik(p_2lp), logLik(p_3lp), logLik(p_4lp), logLik(p_5lp), logLik(p_6lp)),2)

Table_7[31,2:8] <- round(c(AIC((null_plp)), AIC(p_1lp), AIC(p_2lp), AIC(p_3lp), AIC(p_4lp), AIC(p_5lp), AIC(p_6lp)),2)

Table_7[is.na(Table_7)] <- ""

write.csv(Table_7, here::here("results", "TableS7.csv"), row.names = F)

kable(Table_7, col.names = c("","","","","","","",""))


```


## Table 8. Pos extreme. Individual-model dyads

### Build Models


```{r t8}

m_1dp <- lm.cluster(formula=pos10s ~ indiv1 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_2dp <- lm.cluster(formula=pos10s ~ indiv1 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_3dp <- lm.cluster(formula=pos10s ~ indiv1 + indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_4dp <- lm.cluster(formula=pos10s ~ indiv1 + indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_5dp <- lm.cluster(formula=pos10s ~ att + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

m_6dp <- lm.cluster(formula=pos10s ~ att + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)


p_1dp <- lm.cluster(formula=pos10s ~ indiv1 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_2dp <- lm.cluster(formula=pos10s ~ indiv1 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_3dp <- lm.cluster(formula=pos10s ~ indiv1 + indiv3 + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_4dp <- lm.cluster(formula=pos10s ~ indiv1 + indiv3 + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_5dp <- lm.cluster(formula=pos10s ~ att + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

p_6dp <- lm.cluster(formula=pos10s ~ att + pbelief + stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

null_mdp <- lm.cluster(formula=pos10s ~ stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight, cluster = "u_teamid", data = df_dyad)

null_pdp <- lm.cluster(formula=pos10s ~ stats_i + topic_i + t2 + t3 + factor(backgr_degree), weights = df_dyad$pweight*df_dyad$pscore_1, cluster = "u_teamid", data = df_dyad)

# re-run as lm's to get fit stats
source(here("code", "Sub", "t7_fit.R"))

#nobs(m_1ldp)
```

### Build Table

```{r t8b}

Table_8 <- as.data.frame(matrix(nrow = 32, ncol = 8))

Table_8[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")

Table_8[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

#m_ models
Table_8[c(6,8),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_mdp$lm_res$coefficients[i], summary(null_mdp)[i, 2]))
Table_8[c(7,9),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_mdp)[2:3, 2]), 3), nsmall = 3))

Table_8[c(2,6,8),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_1dp$lm_res$coefficients[i], summary(m_1dp)[i, 2]))
Table_8[c(3,7,9),3] <- sprintf("(%s)", format(round(as.numeric(summary(m_1dp)[2:4, 2]), 3), nsmall = 3))

Table_8[c(2,10,6,8),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_2dp$lm_res$coefficients[i], summary(m_2dp)[i, 2]))
Table_8[c(3,11,7,9),4] <- sprintf("(%s)", format(round(as.numeric(summary(m_2dp)[2:5, 2]), 3), nsmall = 3))

Table_8[c(2,4,6,8),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_3dp$lm_res$coefficients[i], summary(m_3dp)[i, 2]))
Table_8[c(3,5,7,9),5] <- sprintf("(%s)", format(round(as.numeric(summary(m_3dp)[2:5, 2]), 3), nsmall = 3))

Table_8[c(2,4,6,8,10),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(m_4dp$lm_res$coefficients[i], summary(m_4dp)[i, 2]))
Table_8[c(3,5,7,9,11),6] <- sprintf("(%s)", format(round(as.numeric(summary(m_4dp)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_8[c(12,6,8),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(m_5dp$lm_res$coefficients[i], summary(m_5dp)[i, 2]))
Table_8[c(13,7,9),7] <- sprintf("(%s)", format(round(as.numeric(summary(m_5dp)[2:4, 2]), 3), nsmall = 3))

Table_8[c(12,10,6,8),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(m_6dp$lm_res$coefficients[i], summary(m_6dp)[i, 2]))
Table_8[c(13,11,7,9),8] <- sprintf("(%s)", format(round(as.numeric(summary(m_6dp)[2:5, 2]), 3), nsmall = 3))

Table_8[16,2:8] <- c(r2ext(null_mdp), r2ext(m_1dp), r2ext(m_2dp), r2ext(m_3dp), r2ext(m_4dp), r2ext(m_5dp), r2ext(m_6dp))

Table_8[14,2:8] <- round(c(logLik((null_mldp)), logLik(m_1ldp), logLik(m_2ldp), logLik(m_3ldp), logLik(m_4ldp), logLik(m_5ldp), logLik(m_6ldp)),2)

Table_8[15,2:8] <- round(c(AIC((null_mlp)), AIC(m_1ldp), AIC(m_2ldp), AIC(m_3ldp), AIC(m_4ldp), AIC(m_5ldp), AIC(m_6ldp)),2)

#p_ models
Table_8[c(22,24),2] <- sapply(2:3, function(i) add_asterisk_if_significant_cluster(null_pdp$lm_res$coefficients[i], summary(null_pdp)[i, 2]))
Table_8[c(23,25),2] <- sprintf("(%s)", format(round(as.numeric(summary(null_pdp)[2:3, 2]), 3), nsmall = 3))

Table_8[c(18,22,24),3] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_1dp$lm_res$coefficients[i], summary(p_1dp)[i, 2]))
Table_8[c(19,23,25),3] <- sprintf("(%s)", format(round(as.numeric(summary(p_1dp)[2:4, 2]), 3), nsmall = 3))

Table_8[c(18,26,22,24),4] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_2dp$lm_res$coefficients[i], summary(p_2dp)[i, 2]))
Table_8[c(19,27,23,25),4] <- sprintf("(%s)", format(round(as.numeric(summary(p_2dp)[2:5, 2]), 3), nsmall = 3))

Table_8[c(18,20,22,24),5] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_3dp$lm_res$coefficients[i], summary(p_3dp)[i, 2]))
Table_8[c(19,21,23,25),5] <- sprintf("(%s)", format(round(as.numeric(summary(p_3dp)[2:5, 2]), 3), nsmall = 3))

Table_8[c(18,20,22,24,26),6] <- sapply(c(2,3,5,6,4), function(i) add_asterisk_if_significant_cluster(p_4dp$lm_res$coefficients[i], summary(p_4dp)[i, 2]))
Table_8[c(19,21,23,25,27),6] <- sprintf("(%s)", format(round(as.numeric(summary(p_4dp)[c(2,3,5,6,4), 2]), 3), nsmall = 3))

Table_8[c(28,22,24),7] <- sapply(2:4, function(i) add_asterisk_if_significant_cluster(p_5dp$lm_res$coefficients[i], summary(p_5dp)[i, 2]))
Table_8[c(29,23,25),7] <- sprintf("(%s)", format(round(as.numeric(summary(p_5dp)[2:4, 2]), 3), nsmall = 3))

Table_8[c(28,26,22,24),8] <- sapply(2:5, function(i) add_asterisk_if_significant_cluster(p_6dp$lm_res$coefficients[i], summary(p_6dp)[i, 2]))
Table_8[c(29,27,23,25),8] <- sprintf("(%s)", format(round(as.numeric(summary(p_6dp)[2:5, 2]), 3), nsmall = 3))

Table_8[32,2:8] <- c(r2ext(null_pdp), r2ext(p_1dp), r2ext(p_2dp), r2ext(p_3dp), r2ext(p_4dp), r2ext(p_5dp), r2ext(p_6dp))

Table_8[30,2:8] <- round(c(logLik((null_pldp)), logLik(p_1ldp), logLik(p_2ldp), logLik(p_3ldp), logLik(p_4ldp), logLik(p_5ldp), logLik(p_6ldp)),2)

Table_8[31,2:8] <- round(c(AIC((null_pldp)), AIC(p_1ldp), AIC(p_2ldp), AIC(p_3ldp), AIC(p_4ldp), AIC(p_5ldp), AIC(p_6ldp)),2)

Table_8[is.na(Table_8)] <- ""

write.csv(Table_8, here::here("results", "TableS8.csv"), row.names = F)

kable(Table_8, col.names = c("","","","","","","",""))


```

## Table 9. Neg Logit

It does not seem to be possible to both weight and cluster using glm binomial. So the cluster has to be done after.

### Build Models

```{r t9, warning = F}

df$nmodel_l <- 1/df$nmodel
df$nmodel_lp <- df$nmodel_l*df$pscore_1

# fit statistics weights adjusted upwards to avoid biased fit statistics
df$fit_l <- 100*(1/df$nmodel)
df$fit_lp <- 100*(df$nmodel_l*df$pscore_1)

log_1n <- glm(formula=neg10s ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_1n_fit <- glm(formula=neg10s ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_2n <- glm(formula=neg10s ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_2n_fit <- glm(formula=neg10s ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_3n <- glm(formula=neg10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_3n_fit <- glm(formula=neg10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_4n <- glm(formula=neg10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_4n_fit <- glm(formula=neg10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_5n <- glm(formula=neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_5n_fit <- glm(formula=neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_6n <- glm(formula=neg10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_6n_fit <- glm(formula=neg10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)


logp_1n <- glm(formula=neg10s ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_1n_fit <- glm(formula=neg10s ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_2n <- glm(formula=neg10s ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_2n_fit <- glm(formula=neg10s ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_3n <- glm(formula=neg10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_3n_fit <- glm(formula=neg10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_4n <- glm(formula=neg10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_4n_fit <- glm(formula=neg10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_5n <- glm(formula=neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_5n_fit <- glm(formula=neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_6n <- glm(formula=neg10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_6n_fit <- glm(formula=neg10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

null_mn <- glm(formula=neg10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

null_mn_fit <- glm(formula=neg10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

null_mn_zero <- glm(formula=neg10s ~ 1,
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

null_pn <- glm(formula=neg10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

null_pn_fit <- glm(formula=neg10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

null_pn_zero <- glm(formula=neg10s ~ 1,
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

```


### Build Table

Note that logistic models need to have the standard errors adjusted post hoc

```{r t9b}

Table_9 <- as.data.frame(matrix(nrow = 32, ncol = 8))

Table_9[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")

Table_9[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

#m_ models
margins_null_mn <- summary(margins(null_mn, vcov = vcovCL(null_mn, cluster = ~ df$u_teamid), variables = c("stats_brw", "topic_brw")))
Table_9[c(6,8),2] <- format(round(margins_null_mn$AME, 3), nsmall = 3)
Table_9[c(7,9),2] <- sprintf("(%s)", format(round(margins_null_mn$SE, 3), nsmall = 3))

# For log_1n model
margins_log_1n <- summary(margins(log_1n, vcov = vcovCL(log_1n, cluster = ~ df$u_teamid), variables = c("group3", "stats_brw", "topic_brw")))
Table_9[c(4,6,8),3] <- format(round(margins_log_1n$AME, 3), nsmall = 3)
Table_9[c(5,7,9),3] <- sprintf("(%s)", format(round(margins_log_1n$SE, 3), nsmall = 3))

# For log_2n model
margins_log_2n <- summary(margins(log_2n, vcov = vcovCL(log_2n, cluster = ~ df$u_teamid), variables = c("group3", "pbelief", "stats_brw", "topic_brw")))
Table_9[c(4,10,6,8),4] <- format(round(margins_log_2n$AME, 3), nsmall = 3)
Table_9[c(5,11,7,9),4] <- sprintf("(%s)", format(round(margins_log_2n$SE, 3), nsmall = 3))

# For log_3n model
margins_log_3n <- summary(margins(log_3n, vcov = vcovCL(log_3n, cluster = ~ df$u_teamid), variables = c("group1", "group3", "stats_brw", "topic_brw")))
Table_9[c(2,4,6,8),5] <- format(round(margins_log_3n$AME, 3), nsmall = 3)
Table_9[c(3,5,7,9),5] <- sprintf("(%s)", format(round(margins_log_3n$SE, 3), nsmall = 3))

# For log_4n model
margins_log_4n <- summary(margins(log_4n, vcov = vcovCL(log_4n, cluster = ~ df$u_teamid), variables = c("group1", "group3", "pbelief", "stats_brw", "topic_brw")))
Table_9[c(2,4,10,6,8),6] <- format(round(margins_log_4n$AME, 3), nsmall = 3)
Table_9[c(3,5,11,7,9),6] <- sprintf("(%s)", format(round(margins_log_4n$SE, 3), nsmall = 3))

# For log_5n model
margins_log_5n <- summary(margins(log_5n, vcov = vcovCL(log_5n, cluster = ~ df$u_teamid), variables = c("proindex", "stats_brw", "topic_brw")))
Table_9[c(12,6,8),7] <- format(round(margins_log_5n$AME, 3), nsmall = 3)
Table_9[c(13,7,9),7] <- sprintf("(%s)", format(round(margins_log_5n$SE, 3), nsmall = 3))

# For log_6n model
margins_log_6n <- summary(margins(log_6n, vcov = vcovCL(log_6n, cluster = ~ df$u_teamid), variables = c("proindex", "pbelief", "stats_brw", "topic_brw")))
Table_9[c(12,10,6,8),8] <- format(round(margins_log_6n$AME, 3), nsmall = 3)
Table_9[c(13,11,7,9),8] <- sprintf("(%s)", format(round(margins_log_6n$SE, 3), nsmall = 3))



Table_9[16,2:8] <- format(round( as.numeric(c((1-(logLik(null_mn_fit)/logLik(null_mn_zero))), (1-(logLik(log_1n_fit)/logLik(null_mn_zero))), (1-(logLik(log_2n_fit)/logLik(null_mn_zero))), (1-(logLik(log_3n_fit)/logLik(null_mn_zero))), (1-(logLik(log_4n_fit)/logLik(null_mn_zero))), (1-(logLik(log_5n_fit)/logLik(null_mn_zero))), (1-(logLik(log_6n_fit))/logLik(null_mn_zero)))),3), nsmall = 3)

Table_9[14,2:8] <- round(c(logLik((null_mn_fit)), logLik(log_1n_fit), logLik(log_2n_fit), logLik(log_3n_fit), logLik(log_4n_fit), logLik(log_5n_fit), logLik(log_6n_fit)),2)

Table_9[15,2:8] <- round(c(AIC((null_mn_fit)), AIC(log_1n_fit), AIC(log_2n_fit), AIC(log_3n_fit), AIC(log_4n_fit), AIC(log_5n_fit), AIC(log_6n_fit)),2)


#p_ models
# For null_pn model
margins_null_pn <- summary(margins(null_pn, vcov = vcovCL(null_pn, cluster = ~ df$u_teamid), variables = c("stats_brw", "topic_brw")))
Table_9[c(22,24),2] <- format(round(margins_null_pn$AME, 3), nsmall = 3)
Table_9[c(23,25),2] <- sprintf("(%s)", format(round(margins_null_pn$SE, 3), nsmall = 3))

# For logp_1n model
margins_logp_1n <- summary(margins(logp_1n, vcov = vcovCL(logp_1n, cluster = ~ df$u_teamid), variables = c("group3", "stats_brw", "topic_brw")))
Table_9[c(20,22,24),3] <- format(round(margins_logp_1n$AME, 3), nsmall = 3)
Table_9[c(21,23,25),3] <- sprintf("(%s)", format(round(margins_logp_1n$SE, 3), nsmall = 3))

# For logp_2n model
margins_logp_2n <- summary(margins(logp_2n, vcov = vcovCL(logp_2n, cluster = ~ df$u_teamid), variables = c("group3", "pbelief", "stats_brw", "topic_brw")))
Table_9[c(20,26,22,24),4] <- format(round(margins_logp_2n$AME, 3), nsmall = 3)
Table_9[c(21,27,23,25),4] <- sprintf("(%s)", format(round(margins_logp_2n$SE, 3), nsmall = 3))

# For logp_3n model
margins_logp_3n <- summary(margins(logp_3n, vcov = vcovCL(logp_3n, cluster = ~ df$u_teamid), variables = c("group1", "group3", "stats_brw", "topic_brw")))
Table_9[c(18,20,22,24),5] <- format(round(margins_logp_3n$AME, 3), nsmall = 3)
Table_9[c(19,21,23,25),5] <- sprintf("(%s)", format(round(margins_logp_3n$SE, 3), nsmall = 3))

# For logp_4n model
margins_logp_4n <- summary(margins(logp_4n, vcov = vcovCL(logp_4n, cluster = ~ df$u_teamid), variables = c("group1", "group3", "pbelief", "stats_brw", "topic_brw")))
Table_9[c(18,20,26,22,24),6] <- format(round(margins_logp_4n$AME, 3), nsmall = 3)
Table_9[c(19,21,27,23,25),6] <- sprintf("(%s)", format(round(margins_logp_4n$SE, 3), nsmall = 3))

# For logp_5n model
margins_logp_5n <- summary(margins(logp_5n, vcov = vcovCL(logp_5n, cluster = ~ df$u_teamid), variables = c("proindex", "stats_brw", "topic_brw")))
Table_9[c(28,22,24),7] <- format(round(margins_logp_5n$AME, 3), nsmall = 3)
Table_9[c(29,23,25),7] <- sprintf("(%s)", format(round(margins_logp_5n$SE, 3), nsmall = 3))

# For logp_6n model
margins_logp_6n <- summary(margins(logp_6n, vcov = vcovCL(logp_6n, cluster = ~ df$u_teamid), variables = c("proindex", "pbelief", "stats_brw", "topic_brw")))
Table_9[c(28,26,22,24),8] <- format(round(margins_logp_6n$AME, 3), nsmall = 3)
Table_9[c(29,27,23,25),8] <- sprintf("(%s)", format(round(margins_logp_6n$SE, 3), nsmall = 3))



Table_9[32,2:8] <- format(round( as.numeric(c((1-(logLik(null_pn_fit)/logLik(null_pn_zero))), (1-(logLik(logp_1n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_2n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_3n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_4n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_5n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_6n_fit))/logLik(null_pn_zero)))),3), nsmall = 3)

Table_9[30,2:8] <- round(c(logLik((null_pn_fit)), logLik(logp_1n_fit), logLik(logp_2n_fit), logLik(logp_3n_fit), logLik(logp_4n_fit), logLik(logp_5n_fit), logLik(logp_6n_fit)),2)

Table_9[31,2:8] <- round(c(AIC((null_pn_fit)), AIC(logp_1n_fit), AIC(logp_2n_fit), AIC(logp_3n_fit), AIC(logp_4n_fit), AIC(logp_5n_fit), AIC(logp_6n_fit)),2)

############ Add stars from table

Table_9 <- add_asterisk_if_significant_by_row(
  Table_9,
  coef_rows = c(2,4,6,8,10,12,18,20,22,24,26,28)
)

Table_9[is.na(Table_9)] <- ""

write.csv(Table_9, here::here("results", "TableS9.csv"), row.names = F)
```

## Table 10. Neg Logit Dyad

### Build Models

```{r t10, warning = F}

# adjust weight to account for number of researchers 154
df_dyad <- df_dyad %>%
  mutate(
    # Transform pweightp and pweighta
    pweightp = pweight / min(pweight, na.rm = T),
    pweighta = pweight * pscore_1,
    
    # Rescale pweightp and pweighta to sum to 154
    pweightp = pweightp * (2709 / sum(pweightp, na.rm = T)),
    pweighta = pweighta * (2709 / sum(pweighta, na.rm = T))
  )

log_1n <- glm(formula=neg10s ~ indiv3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_2n <- glm(formula=neg10s ~ indiv3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_3n <- glm(formula=neg10s ~ indiv1 + indiv3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_4n <- glm(formula=neg10s ~ indiv1 + indiv3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_5n <- glm(formula=neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_6n <- glm(formula=neg10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)


logp_1n <- glm(formula=neg10s ~ indiv3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

logp_2n <- glm(formula=neg10s ~ indiv3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

logp_3n <- glm(formula=neg10s ~ indiv1 + indiv3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

logp_4n <- glm(formula=neg10s ~ indiv1 + indiv3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

logp_5n <- glm(formula=neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

logp_6n <- glm(formula=neg10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

null_mn <- glm(formula=neg10s ~ stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

null_mn_zero <- glm(formula=neg10s ~ 1,
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

null_pn <- glm(formula=neg10s ~ stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

null_pn_zero <- glm(formula=neg10s ~ 1,
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

```


### Build Table

```{r t10b, warning = F}

Table_10 <- as.data.frame(matrix(nrow = 32, ncol = 8))

Table_10[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")

Table_10[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

#m_ models
margins_null_mn <- summary(margins(null_mn, vcov = vcovCL(null_mn, cluster = ~ df_dyad$u_id), variables = c("stats_brw", "topic_brw")))
Table_10[c(6,8),2] <- format(round(margins_null_mn$AME, 3), nsmall = 3)
Table_10[c(7,9),2] <- sprintf("(%s)", format(round(margins_null_mn$SE, 3), nsmall = 3))

# For log_1n model
margins_log_1n <- summary(margins(log_1n, vcov = vcovCL(log_1n, cluster = ~ df_dyad$u_id), variables = c("indiv3", "stats_brw", "topic_brw")))
Table_10[c(4,6,8),3] <- format(round(margins_log_1n$AME, 3), nsmall = 3)
Table_10[c(5,7,9),3] <- sprintf("(%s)", format(round(margins_log_1n$SE, 3), nsmall = 3))

# For log_2n model
margins_log_2n <- summary(margins(log_2n, vcov = vcovCL(log_2n, cluster = ~ df_dyad$u_id), variables = c("indiv3", "pbelief", "stats_brw", "topic_brw")))
Table_10[c(4,10,6,8),4] <- format(round(margins_log_2n$AME, 3), nsmall = 3)
Table_10[c(5,11,7,9),4] <- sprintf("(%s)", format(round(margins_log_2n$SE, 3), nsmall = 3))

# For log_3n model
margins_log_3n <- summary(margins(log_3n, vcov = vcovCL(log_3n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "indiv3", "stats_brw", "topic_brw")))
Table_10[c(2,4,6,8),5] <- format(round(margins_log_3n$AME, 3), nsmall = 3)
Table_10[c(3,5,7,9),5] <- sprintf("(%s)", format(round(margins_log_3n$SE, 3), nsmall = 3))

# For log_4n model
margins_log_4n <- summary(margins(log_4n, vcov = vcovCL(log_4n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "indiv3", "pbelief", "stats_brw", "topic_brw")))
Table_10[c(2,4,10,6,8),6] <- format(round(margins_log_4n$AME, 3), nsmall = 3)
Table_10[c(3,5,11,7,9),6] <- sprintf("(%s)", format(round(margins_log_4n$SE, 3), nsmall = 3))

# For log_5n model
margins_log_5n <- summary(margins(log_5n, vcov = vcovCL(log_5n, cluster = ~ df_dyad$u_id), variables = c("proindex", "stats_brw", "topic_brw")))
Table_10[c(12,6,8),7] <- format(round(margins_log_5n$AME, 3), nsmall = 3)
Table_10[c(13,7,9),7] <- sprintf("(%s)", format(round(margins_log_5n$SE, 3), nsmall = 3))

# For log_6n model
margins_log_6n <- summary(margins(log_6n, vcov = vcovCL(log_6n, cluster = ~ df_dyad$u_id), variables = c("proindex", "pbelief", "stats_brw", "topic_brw")))
Table_10[c(12,10,6,8),8] <- format(round(margins_log_6n$AME, 3), nsmall = 3)
Table_10[c(13,11,7,9),8] <- sprintf("(%s)", format(round(margins_log_6n$SE, 3), nsmall = 3))



Table_10[16,2:8] <- format(round( as.numeric(c((1-(logLik(null_mn)/logLik(null_mn_zero))), (1-(logLik(log_1n)/logLik(null_mn_zero))), (1-(logLik(log_2n)/logLik(null_mn_zero))), (1-(logLik(log_3n)/logLik(null_mn_zero))), (1-(logLik(log_4n)/logLik(null_mn_zero))), (1-(logLik(log_5n)/logLik(null_mn_zero))), (1-(logLik(log_6n))/logLik(null_mn_zero)))),3), nsmall = 3)

Table_10[14,2:8] <- round(c(logLik((null_mn)), logLik(log_1n), logLik(log_2n), logLik(log_3n), logLik(log_4n), logLik(log_5n), logLik(log_6n)),2)

Table_10[15,2:8] <- round(c(AIC((null_mn)), AIC(log_1n), AIC(log_2n), AIC(log_3n), AIC(log_4n), AIC(log_5n), AIC(log_6n)),2)


#p_ models
margins_null_pn <- summary(margins(null_pn, vcov = vcovCL(null_pn, cluster = ~ df_dyad$u_id), variables = c("stats_brw", "topic_brw")))
Table_10[c(22,24),2] <- format(round(margins_null_pn$AME, 3), nsmall = 3)
Table_10[c(23,25),2] <- sprintf("(%s)", format(round(margins_null_pn$SE, 3), nsmall = 3))

# logp_1n model
margins_logp_1n <- summary(margins(logp_1n, vcov = vcovCL(logp_1n, cluster = ~ df_dyad$u_id), variables = c("indiv3", "stats_brw", "topic_brw")))
Table_10[c(20,22,24),3] <- format(round(margins_logp_1n$AME, 3), nsmall = 3)
Table_10[c(21,23,25),3] <- sprintf("(%s)", format(round(margins_logp_1n$SE, 3), nsmall = 3))

# logp_2n model
margins_logp_2n <- summary(margins(logp_2n, vcov = vcovCL(logp_2n, cluster = ~ df_dyad$u_id), variables = c("indiv3", "pbelief", "stats_brw", "topic_brw")))
Table_10[c(20,26,22,24),4] <- format(round(margins_logp_2n$AME, 3), nsmall = 3)
Table_10[c(21,27,23,25),4] <- sprintf("(%s)", format(round(margins_logp_2n$SE, 3), nsmall = 3))

# logp_3n model
margins_logp_3n <- summary(margins(logp_3n, vcov = vcovCL(logp_3n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "indiv3", "stats_brw", "topic_brw")))
Table_10[c(18,20,22,24),5] <- format(round(margins_logp_3n$AME, 3), nsmall = 3)
Table_10[c(19,21,23,25),5] <- sprintf("(%s)", format(round(margins_logp_3n$SE, 3), nsmall = 3))

# logp_4n model
margins_logp_4n <- summary(margins(logp_4n, vcov = vcovCL(logp_4n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "indiv3", "pbelief", "stats_brw", "topic_brw")))
Table_10[c(18,20,26,22,24),6] <- format(round(margins_logp_4n$AME, 3), nsmall = 3)
Table_10[c(19,21,27,23,25),6] <- sprintf("(%s)", format(round(margins_logp_4n$SE, 3), nsmall = 3))

# logp_5n model
margins_logp_5n <- summary(margins(logp_5n, vcov = vcovCL(logp_5n, cluster = ~ df_dyad$u_id), variables = c("proindex", "stats_brw", "topic_brw")))
Table_10[c(28,22,24),7] <- format(round(margins_logp_5n$AME, 3), nsmall = 3)
Table_10[c(29,23,25),7] <- sprintf("(%s)", format(round(margins_logp_5n$SE, 3), nsmall = 3))

# logp_6n model
margins_logp_6n <- summary(margins(logp_6n, vcov = vcovCL(logp_6n, cluster = ~ df_dyad$u_id), variables = c("proindex", "pbelief", "stats_brw", "topic_brw")))
Table_10[c(28,26,22,24),8] <- format(round(margins_logp_6n$AME, 3), nsmall = 3)
Table_10[c(29,27,23,25),8] <- sprintf("(%s)", format(round(margins_logp_6n$SE, 3), nsmall = 3))



Table_10[32,2:8] <- format(round( as.numeric(c((1-(logLik(null_pn)/logLik(null_pn_zero))), (1-(logLik(logp_1n)/logLik(null_pn_zero))), (1-(logLik(logp_2n)/logLik(null_pn_zero))), (1-(logLik(logp_3n)/logLik(null_pn_zero))), (1-(logLik(logp_4n)/logLik(null_pn_zero))), (1-(logLik(logp_5n)/logLik(null_pn_zero))), (1-(logLik(logp_6n))/logLik(null_pn_zero)))),3), nsmall = 3)

Table_10[30,2:8] <- round(c(logLik((null_pn)), logLik(logp_1n), logLik(logp_2n), logLik(logp_3n), logLik(logp_4n), logLik(logp_5n), logLik(logp_6n)),2)

Table_10[31,2:8] <- round(c(AIC((null_pn)), AIC(logp_1n), AIC(logp_2n), AIC(logp_3n), AIC(logp_4n), AIC(logp_5n), AIC(logp_6n)),2)

############ Add stars from table

Table_10 <- add_asterisk_if_significant_by_row(
  Table_10,
  coef_rows = c(2,4,6,8,10,12,18,20,22,24,26,28)
)

Table_10[is.na(Table_10)] <- ""

write.csv(Table_10, here::here("results", "TableS10.csv"), row.names = F)

```

## Table 11. Pos Logit

The fit statistics come to close to zero (Log-Likelihood), these have to be calculated on a model with weights adjusted upwards.

### Build Models

```{r t11, warning = F}

df$nmodel_l <- 1/df$nmodel
df$nmodel_lp <- df$nmodel_l*df$pscore_1

# fit statistics weights adjusted upwards to avoid biased fit statistics
df$fit_l <- 100*(1/df$nmodel)
df$fit_lp <- 100*(df$nmodel_l*df$pscore_1)



log_1n <- glm(formula=pos10s ~ group1 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_1n_fit <- glm(formula=pos10s ~ group1 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_2n <- glm(formula=pos10s ~ group1 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_2n_fit <- glm(formula=pos10s ~ group1 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_3n <- glm(formula=pos10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_3n_fit <- glm(formula=pos10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_4n <- glm(formula=pos10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_4n_fit <- glm(formula=pos10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_5n <- glm(formula=pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_5n_fit <- glm(formula=pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

log_6n <- glm(formula=pos10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

log_6n_fit <- glm(formula=pos10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)


logp_1n <- glm(formula=pos10s ~ group1 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_1n_fit <- glm(formula=pos10s ~ group1 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_2n <- glm(formula=pos10s ~ group1 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_2n_fit <- glm(formula=pos10s ~ group1 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_3n <- glm(formula=pos10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_3n_fit <- glm(formula=pos10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_4n <- glm(formula=pos10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_4n_fit <- glm(formula=pos10s ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_5n <- glm(formula=pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_5n_fit <- glm(formula=pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

logp_6n <- glm(formula=pos10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

logp_6n_fit <- glm(formula=pos10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

null_mn <- glm(formula=pos10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

null_mn_fit <- glm(formula=pos10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

null_mn_zero <- glm(formula=pos10s ~ 1,
             data = df,
             family = binomial(link = "logit"),
             weights = fit_l)

null_pn <- glm(formula=pos10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

null_pn_fit <- glm(formula=pos10s ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

null_pn_zero <- glm(formula=pos10s ~ 1,
             data = df,
             family = binomial(link = "logit"),
             weights = fit_lp)

```


### Build Table

```{r t11b, warning = F}

Table_11 <- as.data.frame(matrix(nrow = 32, ncol = 8))

Table_11[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")

Table_11[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

#m_ models
margins_null_mn <- summary(margins(null_mn, vcov = vcovCL(null_mn, cluster = ~ df$u_teamid), variables = c("stats_brw", "topic_brw")))
Table_11[c(6,8),2] <- format(round(margins_null_mn$AME, 3), nsmall = 3)
Table_11[c(7,9),2] <- sprintf("(%s)", format(round(margins_null_mn$SE, 3), nsmall = 3))

# For log_1n model
margins_log_1n <- summary(margins(log_1n, vcov = vcovCL(log_1n, cluster = ~ df$u_teamid), variables = c("group1", "stats_brw", "topic_brw")))
Table_11[c(2,6,8),3] <- format(round(margins_log_1n$AME, 3), nsmall = 3)
Table_11[c(3,7,9),3] <- sprintf("(%s)", format(round(margins_log_1n$SE, 3), nsmall = 3))

# For log_2n model
margins_log_2n <- summary(margins(log_2n, vcov = vcovCL(log_2n, cluster = ~ df$u_teamid), variables = c("group1", "pbelief", "stats_brw", "topic_brw")))
Table_11[c(2,10,6,8),4] <- format(round(margins_log_2n$AME, 3), nsmall = 3)
Table_11[c(3,11,7,9),4] <- sprintf("(%s)", format(round(margins_log_2n$SE, 3), nsmall = 3))

# For log_3n model
margins_log_3n <- summary(margins(log_3n, vcov = vcovCL(log_3n, cluster = ~ df$u_teamid), variables = c("group1", "group3", "stats_brw", "topic_brw")))
Table_11[c(2,4,6,8),5] <- format(round(margins_log_3n$AME, 3), nsmall = 3)
Table_11[c(3,5,7,9),5] <- sprintf("(%s)", format(round(margins_log_3n$SE, 3), nsmall = 3))

# For log_4n model
margins_log_4n <- summary(margins(log_4n, vcov = vcovCL(log_4n, cluster = ~ df$u_teamid), variables = c("group1", "group3", "pbelief", "stats_brw", "topic_brw")))
Table_11[c(2,4,10,6,8),6] <- format(round(margins_log_4n$AME, 3), nsmall = 3)
Table_11[c(3,5,11,7,9),6] <- sprintf("(%s)", format(round(margins_log_4n$SE, 3), nsmall = 3))

# For log_5n model
margins_log_5n <- summary(margins(log_5n, vcov = vcovCL(log_5n, cluster = ~ df$u_teamid), variables = c("proindex", "stats_brw", "topic_brw")))
Table_11[c(12,6,8),7] <- format(round(margins_log_5n$AME, 3), nsmall = 3)
Table_11[c(13,7,9),7] <- sprintf("(%s)", format(round(margins_log_5n$SE, 3), nsmall = 3))

# For log_6n model
margins_log_6n <- summary(margins(log_6n, vcov = vcovCL(log_6n, cluster = ~ df$u_teamid), variables = c("proindex", "pbelief", "stats_brw", "topic_brw")))
Table_11[c(12,10,6,8),8] <- format(round(margins_log_6n$AME, 3), nsmall = 3)
Table_11[c(13,11,7,9),8] <- sprintf("(%s)", format(round(margins_log_6n$SE, 3), nsmall = 3))



Table_11[16,2:8] <- format(round( as.numeric(c((1-(logLik(null_mn_fit)/logLik(null_mn_zero))), (1-(logLik(log_1n_fit)/logLik(null_mn_zero))), (1-(logLik(log_2n_fit)/logLik(null_mn_zero))), (1-(logLik(log_3n_fit)/logLik(null_mn_zero))), (1-(logLik(log_4n_fit)/logLik(null_mn_zero))), (1-(logLik(log_5n_fit)/logLik(null_mn_zero))), (1-(logLik(log_6n_fit))/logLik(null_mn_zero)))),3), nsmall = 3)

Table_11[14,2:8] <- round(c(logLik((null_mn_fit)), logLik(log_1n_fit), logLik(log_2n_fit), logLik(log_3n_fit), logLik(log_4n_fit), logLik(log_5n_fit), logLik(log_6n_fit)),2)

Table_11[15,2:8] <- round(c(AIC((null_mn_fit)), AIC(log_1n_fit), AIC(log_2n_fit), AIC(log_3n_fit), AIC(log_4n_fit), AIC(log_5n_fit), AIC(log_6n_fit)),2)


#p_ models
margins_null_pn <- summary(margins(null_pn, vcov = vcovCL(null_pn, cluster = ~ df$u_teamid), variables = c("stats_brw", "topic_brw")))
Table_11[c(22,24),2] <- format(round(margins_null_pn$AME, 3), nsmall = 3)
Table_11[c(23,25),2] <- sprintf("(%s)", format(round(margins_null_pn$SE, 3), nsmall = 3))

# For logp_1n model
margins_logp_1n <- summary(margins(logp_1n, vcov = vcovCL(logp_1n, cluster = ~ df$u_teamid), variables = c("group1", "stats_brw", "topic_brw")))
Table_11[c(18,22,24),3] <- format(round(margins_logp_1n$AME, 3), nsmall = 3)
Table_11[c(19,23,25),3] <- sprintf("(%s)", format(round(margins_logp_1n$SE, 3), nsmall = 3))

# For logp_2n model
margins_logp_2n <- summary(margins(logp_2n, vcov = vcovCL(logp_2n, cluster = ~ df$u_teamid), variables = c("group1", "pbelief", "stats_brw", "topic_brw")))
Table_11[c(18,26,22,24),4] <- format(round(margins_logp_2n$AME, 3), nsmall = 3)
Table_11[c(19,27,23,25),4] <- sprintf("(%s)", format(round(margins_logp_2n$SE, 3), nsmall = 3))

# For logp_3n model
margins_logp_3n <- summary(margins(logp_3n, vcov = vcovCL(logp_3n, cluster = ~ df$u_teamid), variables = c("group1", "group3", "stats_brw", "topic_brw")))
Table_11[c(18,20,22,24),5] <- format(round(margins_logp_3n$AME, 3), nsmall = 3)
Table_11[c(19,21,23,25),5] <- sprintf("(%s)", format(round(margins_logp_3n$SE, 3), nsmall = 3))

# For logp_4n model
margins_logp_4n <- summary(margins(logp_4n, vcov = vcovCL(logp_4n, cluster = ~ df$u_teamid), variables = c("group1", "group3", "pbelief", "stats_brw", "topic_brw")))
Table_11[c(18,20,26,22,24),6] <- format(round(margins_logp_4n$AME, 3), nsmall = 3)
Table_11[c(19,21,27,23,25),6] <- sprintf("(%s)", format(round(margins_logp_4n$SE, 3), nsmall = 3))

# For logp_5n model
margins_logp_5n <- summary(margins(logp_5n, vcov = vcovCL(logp_5n, cluster = ~ df$u_teamid), variables = c("proindex", "stats_brw", "topic_brw")))
Table_11[c(28,22,24),7] <- format(round(margins_logp_5n$AME, 3), nsmall = 3)
Table_11[c(29,23,25),7] <- sprintf("(%s)", format(round(margins_logp_5n$SE, 3), nsmall = 3))

# For logp_6n model
margins_logp_6n <- summary(margins(logp_6n, vcov = vcovCL(logp_6n, cluster = ~ df$u_teamid), variables = c("proindex", "pbelief", "stats_brw", "topic_brw")))
Table_11[c(28,26,22,24),8] <- format(round(margins_logp_6n$AME, 3), nsmall = 3)
Table_11[c(29,27,23,25),8] <- sprintf("(%s)", format(round(margins_logp_6n$SE, 3), nsmall = 3))


Table_11[32,2:8] <- format(round( as.numeric(c((1-(logLik(null_pn_fit)/logLik(null_pn_zero))), (1-(logLik(logp_1n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_2n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_3n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_4n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_5n_fit)/logLik(null_pn_zero))), (1-(logLik(logp_6n_fit))/logLik(null_pn_zero)))),3), nsmall = 3)

Table_11[30,2:8] <- round(c(logLik((null_pn_fit)), logLik(logp_1n_fit), logLik(logp_2n_fit), logLik(logp_3n_fit), logLik(logp_4n_fit), logLik(logp_5n_fit), logLik(logp_6n_fit)),2)

Table_11[31,2:8] <- round(c(AIC((null_pn_fit)), AIC(logp_1n_fit), AIC(logp_2n_fit), AIC(logp_3n_fit), AIC(logp_4n_fit), AIC(logp_5n_fit), AIC(logp_6n_fit)),2)

############ Add stars from table

Table_11 <- add_asterisk_if_significant_by_row(
  Table_11,
  coef_rows = c(2,4,6,8,10,12,18,20,22,24,26,28)
)

Table_11[is.na(Table_11)] <- ""

write.csv(Table_11, here::here("results", "TableS11.csv"), row.names = F)
```


## Table 12. Pos Logit Dyad

### Build Models

```{r t12, warning = F}

# adjust weight to account for number of researchers 154
df_dyad <- df_dyad %>%
  mutate(
    # Transform pweightp and pweighta
    pweightp = pweight / min(pweight, na.rm = T),
    pweighta = pweight * pscore_1,
    
    # Rescale pweightp and pweighta to sum to 154
    pweightp = pweightp * (154 / sum(pweightp, na.rm = T)),
    pweighta = pweighta * (154 / sum(pweighta, na.rm = T))
  )

log_1n <- glm(formula=pos10s ~ indiv1 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_2n <- glm(formula=pos10s ~ indiv1 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_3n <- glm(formula=pos10s ~ indiv1 + indiv3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_4n <- glm(formula=pos10s ~ indiv1 + indiv3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_5n <- glm(formula=pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

log_6n <- glm(formula=pos10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)


logp_1n <- glm(formula=pos10s ~ indiv1 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

logp_2n <- glm(formula=pos10s ~ indiv1 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

logp_3n <- glm(formula=pos10s ~ indiv1 + indiv3 + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

logp_4n <- glm(formula=pos10s ~ indiv1 + indiv3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

logp_5n <- glm(formula=pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

logp_6n <- glm(formula=pos10s ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

null_mn <- glm(formula=pos10s ~ stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

null_mn_zero <- glm(formula=pos10s ~ 1,
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweightp)

null_pn <- glm(formula=pos10s ~ stats_brw + topic_brw + t2 + t3 + factor(backgr_degree),
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

null_pn_zero <- glm(formula=pos10s ~ 1,
             data = df_dyad,
             family = binomial(link = "logit"),
             weights = pweighta)

```


### Build Table

```{r t11b}

Table_12 <- as.data.frame(matrix(nrow = 32, ncol = 8))

Table_12[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC",  "R-squared", "", "Anti-immigration team", "", "Pro-immigration team", "",  "Statistical skills", "", "Topic experience", "","Hypothesis prior", "", "Pro-immigration index", "", "Log-Lik", "AIC", "R-squared")

Table_12[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

# Extract coefficients and SEs directly using margins for each model

# null_mn model
margins_null_mn <- summary(margins(null_mn, vcov = vcovCL(null_mn, cluster = ~ df_dyad$u_id), variables = c("stats_brw", "topic_brw")))
Table_12[c(6,8),2] <- format(round(margins_null_mn$AME, 3), nsmall = 3)
Table_12[c(7,9),2] <- sprintf("(%s)", format(round(margins_null_mn$SE, 3), nsmall = 3))

# log_1n model
margins_log_1n <- summary(margins(log_1n, vcov = vcovCL(log_1n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "stats_brw", "topic_brw")))
Table_12[c(2,6,8),3] <- format(round(margins_log_1n$AME, 3), nsmall = 3)
Table_12[c(3,7,9),3] <- sprintf("(%s)", format(round(margins_log_1n$SE, 3), nsmall = 3))

# log_2n model
margins_log_2n <- summary(margins(log_2n, vcov = vcovCL(log_2n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "pbelief", "stats_brw", "topic_brw")))
Table_12[c(2,10,6,8),4] <- format(round(margins_log_2n$AME, 3), nsmall = 3)
Table_12[c(3,11,7,9),4] <- sprintf("(%s)", format(round(margins_log_2n$SE, 3), nsmall = 3))

# log_3n model
margins_log_3n <- summary(margins(log_3n, vcov = vcovCL(log_3n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "indiv3", "stats_brw", "topic_brw")))
Table_12[c(2,4,6,8),5] <- format(round(margins_log_3n$AME, 3), nsmall = 3)
Table_12[c(3,5,7,9),5] <- sprintf("(%s)", format(round(margins_log_3n$SE, 3), nsmall = 3))

# log_4n model
margins_log_4n <- summary(margins(log_4n, vcov = vcovCL(log_4n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "indiv3", "pbelief", "stats_brw", "topic_brw")))
Table_12[c(2,4,10,6,8),6] <- format(round(margins_log_4n$AME, 3), nsmall = 3)
Table_12[c(3,5,11,7,9),6] <- sprintf("(%s)", format(round(margins_log_4n$SE, 3), nsmall = 3))

# log_5n model
margins_log_5n <- summary(margins(log_5n, vcov = vcovCL(log_5n, cluster = ~ df_dyad$u_id), variables = c("proindex", "stats_brw", "topic_brw")))
Table_12[c(12,6,8),7] <- format(round(margins_log_5n$AME, 3), nsmall = 3)
Table_12[c(13,7,9),7] <- sprintf("(%s)", format(round(margins_log_5n$SE, 3), nsmall = 3))

# log_6n model
margins_log_6n <- summary(margins(log_6n, vcov = vcovCL(log_6n, cluster = ~ df_dyad$u_id), variables = c("proindex", "pbelief", "stats_brw", "topic_brw")))
Table_12[c(12,10,6,8),8] <- format(round(margins_log_6n$AME, 3), nsmall = 3)
Table_12[c(13,11,7,9),8] <- sprintf("(%s)", format(round(margins_log_6n$SE, 3), nsmall = 3))


Table_12[16,2:8] <- format(round( as.numeric(c((1-(logLik(null_mn)/logLik(null_mn_zero))), (1-(logLik(log_1n)/logLik(null_mn_zero))), (1-(logLik(log_2n)/logLik(null_mn_zero))), (1-(logLik(log_3n)/logLik(null_mn_zero))), (1-(logLik(log_4n)/logLik(null_mn_zero))), (1-(logLik(log_5n)/logLik(null_mn_zero))), (1-(logLik(log_6n))/logLik(null_mn_zero)))),3), nsmall = 3)

Table_12[14,2:8] <- round(c(logLik((null_mn)), logLik(log_1n), logLik(log_2n), logLik(log_3n), logLik(log_4n), logLik(log_5n), logLik(log_6n)),2)

Table_12[15,2:8] <- round(c(AIC((null_mn)), AIC(log_1n), AIC(log_2n), AIC(log_3n), AIC(log_4n), AIC(log_5n), AIC(log_6n)),2)


#p_ models
# Directly use `margins` with clustered standard errors

# null_pn model
margins_null_pn <- summary(margins(null_pn, vcov = vcovCL(null_pn, cluster = ~ df_dyad$u_id), variables = c("stats_brw", "topic_brw")))
Table_12[c(22,24),2] <- format(round(margins_null_pn$AME, 3), nsmall = 3)
Table_12[c(23,25),2] <- sprintf("(%s)", format(round(margins_null_pn$SE, 3), nsmall = 3))

# logp_1n model
margins_logp_1n <- summary(margins(logp_1n, vcov = vcovCL(logp_1n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "stats_brw", "topic_brw")))
Table_12[c(18,22,24),3] <- format(round(margins_logp_1n$AME, 3), nsmall = 3)
Table_12[c(19,23,25),3] <- sprintf("(%s)", format(round(margins_logp_1n$SE, 3), nsmall = 3))

# logp_2n model
margins_logp_2n <- summary(margins(logp_2n, vcov = vcovCL(logp_2n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "pbelief", "stats_brw", "topic_brw")))
Table_12[c(18,26,22,24),4] <- format(round(margins_logp_2n$AME, 3), nsmall = 3)
Table_12[c(19,27,23,25),4] <- sprintf("(%s)", format(round(margins_logp_2n$SE, 3), nsmall = 3))

# logp_3n model
margins_logp_3n <- summary(margins(logp_3n, vcov = vcovCL(logp_3n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "indiv3", "stats_brw", "topic_brw")))
Table_12[c(18,20,22,24),5] <- format(round(margins_logp_3n$AME, 3), nsmall = 3)
Table_12[c(19,21,23,25),5] <- sprintf("(%s)", format(round(margins_logp_3n$SE, 3), nsmall = 3))

# logp_4n model
margins_logp_4n <- summary(margins(logp_4n, vcov = vcovCL(logp_4n, cluster = ~ df_dyad$u_id), variables = c("indiv1", "indiv3", "pbelief", "stats_brw", "topic_brw")))
Table_12[c(18,20,26,22,24),6] <- format(round(margins_logp_4n$AME, 3), nsmall = 3)
Table_12[c(19,21,27,23,25),6] <- sprintf("(%s)", format(round(margins_logp_4n$SE, 3), nsmall = 3))

# logp_5n model
margins_logp_5n <- summary(margins(logp_5n, vcov = vcovCL(logp_5n, cluster = ~ df_dyad$u_id), variables = c("proindex", "stats_brw", "topic_brw")))
Table_12[c(28,22,24),7] <- format(round(margins_logp_5n$AME, 3), nsmall = 3)
Table_12[c(29,23,25),7] <- sprintf("(%s)", format(round(margins_logp_5n$SE, 3), nsmall = 3))

# logp_6n model
margins_logp_6n <- summary(margins(logp_6n, vcov = vcovCL(logp_6n, cluster = ~ df_dyad$u_id), variables = c("proindex", "pbelief", "stats_brw", "topic_brw")))
Table_12[c(28,26,22,24),8] <- format(round(margins_logp_6n$AME, 3), nsmall = 3)
Table_12[c(29,27,23,25),8] <- sprintf("(%s)", format(round(margins_logp_6n$SE, 3), nsmall = 3))



Table_12[32,2:8] <- format(round( as.numeric(c((1-(logLik(null_pn)/logLik(null_pn_zero))), (1-(logLik(logp_1n)/logLik(null_pn_zero))), (1-(logLik(logp_2n)/logLik(null_pn_zero))), (1-(logLik(logp_3n)/logLik(null_pn_zero))), (1-(logLik(logp_4n)/logLik(null_pn_zero))), (1-(logLik(logp_5n)/logLik(null_pn_zero))), (1-(logLik(logp_6n))/logLik(null_pn_zero)))),3), nsmall = 3)

Table_12[30,2:8] <- round(c(logLik((null_pn)), logLik(logp_1n), logLik(logp_2n), logLik(logp_3n), logLik(logp_4n), logLik(logp_5n), logLik(logp_6n)),2)

Table_12[31,2:8] <- round(c(AIC((null_pn)), AIC(logp_1n), AIC(logp_2n), AIC(logp_3n), AIC(logp_4n), AIC(logp_5n), AIC(logp_6n)),2)

############ Add stars from table

Table_12 <- add_asterisk_if_significant_by_row(
  Table_12,
  coef_rows = c(2,4,6,8,10,12)
)

Table_12 <- add_asterisk_if_significant_by_row(
  Table_12,
  coef_rows = c(18,20,22,24,26,28)
)

Table_12[is.na(Table_12)] <- ""

write.csv(Table_12, here::here("results", "TableS12.csv"), row.names = F)

```

## Table 13. Referee Score

### Build Models

> length(df$quality2[df$quality2 != 0])
[1] 314
> 314/1215
[1] 0.2584362
> min(df$peer_mean_Z[df$quality2 == 1])
[1] NA
> min(df$peer_mean_Z[df$quality2 == 1], na.rm = T)
[1] 1.075595

```{r t13}

q_null <- lm(peer_mean_Z ~ + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, data = df)

q_1 <- lm(peer_mean_Z ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, data = df)

q_2 <- lm(peer_mean_Z ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, data = df)

qh_null <- lm(quality2 ~ + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, data = df)

qh_1 <- lm(quality2 ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, data = df)

qh_2 <- lm(quality2 ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, data = df)



```


### Build Table

```{r t13b}
# Define a function to add an asterisk if p-value < 0.01


# Build the table with asterisks for significant coefficients
Table_13 <- as.data.frame(matrix(nrow = 12, ncol = 7))
Table_13[,1] <- c("Variable", "Anti-immigration team", "", "Pro-immigration team", "", "Statistical skills", "", "Topic experience", "", "Log-Lik", "AIC", "R-squared")
Table_13[1,2:7] <- c("Null_1", "(1)", "(2)", "Null_2", "(3)", "(4)")

# Apply the function for each set of coefficients and standard errors
Table_13[c(6,8),2] <- sapply(2:3, function(i) add_asterisk_if_significant(q_null$coefficients[i], summary(q_null)$coefficients[i, "Std. Error"]))
Table_13[c(7,9),2] <- sprintf("(%s)", format(round(as.numeric(summary(q_null)$coefficients[2:3, "Std. Error"]), 3), nsmall = 3))

Table_13[c(4,6,8),3] <- sapply(2:4, function(i) add_asterisk_if_significant(q_1$coefficients[i], summary(q_1)$coefficients[i, "Std. Error"]))
Table_13[c(5,7,9),3] <- sprintf("(%s)", format(round(as.numeric(summary(q_1)$coefficients[2:4, "Std. Error"]), 3), nsmall = 3))

Table_13[c(2,4,6,8),4] <- sapply(2:5, function(i) add_asterisk_if_significant(q_2$coefficients[i], summary(q_2)$coefficients[i, "Std. Error"]))
Table_13[c(3,5,7,9),4] <- sprintf("(%s)", format(round(as.numeric(summary(q_2)$coefficients[2:5, "Std. Error"]), 3), nsmall = 3))

Table_13[c(6,8),5] <- sapply(2:3, function(i) add_asterisk_if_significant(qh_null$coefficients[i], summary(qh_null)$coefficients[i, "Std. Error"]))
Table_13[c(7,9),5] <- sprintf("(%s)", format(round(as.numeric(summary(qh_null)$coefficients[2:3, "Std. Error"]), 3), nsmall = 3))

Table_13[c(4,6,8),6] <- sapply(2:4, function(i) add_asterisk_if_significant(qh_1$coefficients[i], summary(qh_1)$coefficients[i, "Std. Error"]))
Table_13[c(5,7,9),6] <- sprintf("(%s)", format(round(as.numeric(summary(qh_1)$coefficients[2:4, "Std. Error"]), 3), nsmall = 3))

Table_13[c(2,4,6,8),7] <- sapply(2:5, function(i) add_asterisk_if_significant(qh_2$coefficients[i], summary(qh_2)$coefficients[i, "Std. Error"]))
Table_13[c(3,5,7,9),7] <- sprintf("(%s)", format(round(as.numeric(summary(qh_2)$coefficients[2:5, "Std. Error"]), 3), nsmall = 3))

# Add R-squared, Log-Likelihood, and AIC values
Table_13[12,2:7] <- c(r2x(q_null), r2x(q_1), r2x(q_2), r2x(qh_null), r2x(qh_1), r2x(qh_2))
Table_13[10,2:7] <- round(c(logLik((q_null)), logLik(q_1), logLik(q_2), logLik(qh_null), logLik(qh_1), logLik(qh_2)), 2)
Table_13[11,2:7] <- round(c(AIC((q_null)), AIC(q_1), AIC(q_2), AIC(qh_null), AIC(qh_1), AIC(qh_2)), 2)

# Replace NA values with an empty string
Table_13[is.na(Table_13)] <- ""

# Save the table as a CSV file
write.csv(Table_13, here::here("results", "TableS13.csv"), row.names = FALSE)



#nobs(q_1)

```


## Table 14. Expected AME

### Build Models

```{r t14}
df <- df %>%
  mutate(unique_combo = paste(Scale, Stock, Flow, level_cyear, allavailable, w1996, w2006, w2016, sep = "_")) %>%
  mutate(indicator = as.numeric(factor(unique_combo)))

df <- df %>%
  # Group by the unique combination
  group_by(unique_combo) %>%
  # Calculate the mean of 'ame' for each unique combination 
  mutate(ame_combo_mean = mean(AME, na.rm = T),
         peer_combo_mean = mean(pscore_Z, na.rm = T)) %>%
  ungroup()

df$resid <- df$AME - df$ame_combo_mean

m_mame <- lm.cluster(formula=resid ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

coef_group1 <- m_3$lm_res$coefficients["group1"]
coef_group3 <- m_3$lm_res$coefficients["group3"]

se_group1 <- as.numeric(summary(m_3)[2,2])
se_group3 <- as.numeric(summary(m_3)[3,2])

coef_diff <- coef_group1 - coef_group3
se_diff <- sqrt(se_group1^2 + se_group3^2)

z_score <- coef_diff / se_diff
p_value <- 2 * (1 - pnorm(abs(z_score)))  

coef_group1m <- m_mame$lm_res$coefficients["group1"]
coef_group3m <- m_mame$lm_res$coefficients["group3"]

se_group1m <- as.numeric(summary(m_mame)[2,2])
se_group3m <- as.numeric(summary(m_mame)[3,2])

coef_diffm <- coef_group1m - coef_group3m
se_diffm <- sqrt(se_group1m^2 + se_group3m^2)

z_scorem <- coef_diffm / se_diffm
p_valuem <- 2 * (1 - pnorm(abs(z_scorem)))  


```

### Build Table

```{r t14b}

Table_14 <- as.data.frame(matrix(ncol = 4, nrow = 4))

Table_14[1,] <- c("", "Anti-immigration coef.", "Pro-immigration coef.", "Difference")

Table_14[,1] <- c("", "Main model", "Residual, AME - expected", "Percent not explained by expected values")

Table_14[2,2:4] <- format(round(c(coef_group1, coef_group3, coef_diff), 3), nsmall = 3)

Table_14[3,2:4] <- format(round(c(coef_group1m, coef_group3m, coef_diffm), 3), nsmall = 3)

Table_14[4,4] <- format(round((coef_diffm/coef_diff)*100,1), nsmall = 1)
                  
Table_14[is.na(Table_14)] <- ""


write_csv(Table_14, "results", "TableS14.csv")


```




## Save Regression Estimates

```{r savereg}

reg_results <- save(m_1, m_3, p_1, p_3, m_1d, m_3d, p_1d, p_3d, m_1n, m_3n, p_1n, p_3n, m_1p, m_3p, p_1p, p_3p, file = here("results","reg_results.Rdata"))

```

## Citations

```{r cites}

packages %>%
  map(citation) %>%
  print(style = "text")

```

## Colophon

```{r colo}

sessionInfo()

```

