---
title: "02 Analyses"
output: html_notebook
---
Replication workflow for:

"Ideological Bias in Estimates of the Impact of Immigration"

[George J. Borjas](https://www.hks.harvard.edu/faculty/george-borjas) <br>
[Nate Brezau](https://sites.google.com/site/nbreznau/) <br>

The original workflow was developed by Borjas using Stata (see `reg_model.do` in this repository), and this workflow is an identical set of analyses by Breznau done in R. 

The file `df.rds` (also available as csv) was generated in the file `01_Data_Prep.Rmd`.

## Setup

```{r setup}

packages <- c("tidyverse",
              "knitr",
              "miceadds",
              "pacman",
              "here",
              #"jtools",
              #"sjPlot",
              "stringr",
              "sandwich",
              "clubSandwich",
              "lmtest",
              "haven",
              "margins",
              "numDeriv",
              "pscl",
              "mediation")

pacman::p_load(packages, character.only = T)

```

## Data

```{r save}

df <- read_rds(here("data", "df.rds"))

# original dataset taken from Stata
df_stata <- read_dta(here("data", "model.dta"))

```

## Models per Team

```{r amedesc}

team_ame_counts <- df %>%
  group_by(u_teamid) %>%
  summarize(count_AME = n()) # Count the number of AME values per u_teamid

overall_summary <- team_ame_counts %>%
  summarize(mean_count = mean(count_AME),
            sd_count = sd(count_AME))

overall_summary
```

## Table 1 & 5. Summary Stats

```{r tbl1}
tbl1_team <- df %>%
  dplyr::select(u_teamid, index, AME, neg10s, pos10s, proindex, dindex, p12, p34, p56, group1, group2, group3, pbelief,  nmodel, team_size,
	stats_brw, topic_brw, model_brw, peer_mean, quality, quality2, Hrej, highstats:highmodel) %>%
  group_by(u_teamid) %>%
  summarise_all(., mean, na.rm = T) %>%
  dplyr::select(-u_teamid) %>%
  ungroup()

tbl1_model <- df %>%
  dplyr::select(index, AME, neg10s, pos10s, group1, group2, group3, pbelief,  nmodel, team_size, stats_brw, topic_brw, model_brw, peer_mean, quality, quality2, Hrej, highstats:highmodel)

tbl1_model_w <- df %>%
  dplyr::select(index, team_size, AME, neg10s, pos10s, nmodel)

tbl_5_model <- df %>% 
  dplyr::select(index, Scale, Stock, Flow, level_cyear, allavailable, w1996, w2006, w2016)
```

#### Table 1

##### T1 Model Level

```{r tbl1_model, warning = F}
n1 <- length(tbl1_model$index)
n2 <- length(tbl1_model$index[tbl1_model$index == 1])
n3 <- length(tbl1_model$index[tbl1_model$index == 2])
n4 <- length(tbl1_model$index[tbl1_model$index == 3])

mean1 <- tbl1_model %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "All teams")

mean2 <- tbl1_model %>%
  filter(index == 1) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Anti-imm")

mean3 <- tbl1_model %>%
  filter(index == 2) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Moderate")

mean4 <- tbl1_model %>%
  filter(index == 3) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Pro-imm")

Table_1_model <- bind_rows(mean1, mean2, mean3, mean4) %>%
  pivot_longer(cols = -sample, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = sample, values_from = Mean)

Table_1_model[,2:5] <- round(Table_1_model[,2:5], 3)

```

##### T1 Model Level - Weighted

```{r tbl1_model_w, warning = F}
mean1 <- tbl1_model_w %>%
  summarise(across(-index, ~ weighted.mean(.x, w = 1 / nmodel, na.rm = TRUE))) %>%
  mutate(sample = "All teams")

mean2 <- tbl1_model_w %>%
  filter(index == 1) %>%
  summarise(across(-index, ~ weighted.mean(.x, w = 1 / nmodel, na.rm = TRUE))) %>%
  mutate(sample = "Anti-imm")

mean3 <- tbl1_model_w %>%
  filter(index == 2) %>%
  summarise(across(-index, ~ weighted.mean(.x, w = 1 / nmodel, na.rm = TRUE))) %>%
  mutate(sample = "Moderate")

mean4 <- tbl1_model_w %>%
  filter(index == 3) %>%
  summarise(across(-index, ~ weighted.mean(.x, w = 1 / nmodel, na.rm = TRUE))) %>%
  mutate(sample = "Pro-imm")

Table_1_model_w <- bind_rows(mean1, mean2, mean3, mean4) %>%
  pivot_longer(cols = -sample, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = sample, values_from = Mean)

Table_1_model_w[,2:5] <- round(Table_1_model_w[,2:5], 3)

Table_1_model_w <- as.data.frame(Table_1_model_w)

Table_1_model_w[1, 1:5] <- c("Num of teams",
                            length(tbl1_team$AME),
                            sum(tbl1_team$group1 == 1),
                            sum(tbl1_team$group2 == 1),
                            sum(tbl1_team$group3 == 1)
                            )

saveRDS(Table_1_model_w, here("results", "Table_1_model_w.rds"))
```

##### T1 Team Level

```{r tbl1_team}
nm1 <- length(tbl1_team$index)
nm2 <- length(tbl1_team$index[tbl1_team$index == 1])
nm3 <- length(tbl1_team$index[tbl1_team$index == 2])
nm4 <- length(tbl1_team$index[tbl1_team$index == 3])

mean1 <- tbl1_team %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "All teams")

mean2 <- tbl1_team %>%
  filter(index == 1) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Anti-imm")

mean3 <- tbl1_team %>%
  filter(index == 2) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Moderate")

mean4 <- tbl1_team %>%
  filter(index == 3) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Pro-imm")

Table_1_team <- bind_rows(mean1, mean2, mean3, mean4) %>%
  pivot_longer(cols = -sample, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = sample, values_from = Mean)

Table_1_team[,2:5] <- round(Table_1_team[,2:5], 3)

```

##### Build Table

```{r buildt1}

Table_1 <- as.data.frame(matrix(nrow = 15, ncol = 5))

Table_1[,1] <- c("Variable", "Mean AME", "% AME negative and significant", "% AME positive and significant", "Mean immigration sentiment", "% Anti-immigration teams", "% Moderate teams", "% Pro-immigration teams", "% Believe hypothesis", "% High statistical skills", "% High topic experience", "% High referee score", "Team size", "N models", "N teams")

Table_1[1,2:5] <- c("All teams", "Anti-imm", "Moderate", "Pro-imm")

# Model-level summaries
Table_1[2:4,2:5] <- Table_1_model[1:3,2:5]

# Team-level summaries
Table_1_team <- subset(Table_1_team, Variable %in% c("proindex", "group1", "group2", "group3", "pbelief", "highstats", "hightopic", "team_size"))

Table_1[c(5:11,13),2:5] <- Table_1_team[,2:5]

Table_1[12,2:5] <- Table_1_model[20,2:5]
Table_1[14,2:5] <- c(n1, n2, n3, n4)
Table_1[15,2:5] <- c(nm1, nm2, nm3, nm4)

kable(Table_1, col.names = c("","","","",""))

```
#### Table 5

```{r t5b}

mean1 <- tbl_5_model %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "All teams")

mean2 <- tbl_5_model %>%
  filter(index == 1) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Anti-imm")

mean3 <- tbl_5_model %>%
  filter(index == 2) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Moderate")

mean4 <- tbl_5_model %>%
  filter(index == 3) %>%
  summarise(across(-index, mean, na.rm = T)) %>%
  mutate(sample = "Pro-imm")

Table_5 <- bind_rows(mean1, mean2, mean3, mean4) %>%
  pivot_longer(cols = -sample, names_to = "Variable", values_to = "Mean") %>%
  pivot_wider(names_from = sample, values_from = Mean)

Table_5[,2:5] <- round(Table_5[,2:5], 3)

kable(Table_5, col.names = c("Design decision", "All teams", "Anti- immigration", "Moderate", "Pro- immigration"))
```


### Table 2. Basic Regressions

#### Build Models

```{r t2rs}

m_1 <- lm.cluster(formula=AME ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

# without clustered se for lokLik and AIC calculation

source(here::here("code", "t2_fit.R"))

# check that I have produced an identical dataset
#m1s <- lm.cluster(formula=ame ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df_stata$nmodel, cluster = "u_teamid", data = df_stata)

m_2 <- lm.cluster(formula=AME ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_3 <- lm.cluster(formula=AME ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_4 <- lm.cluster(formula=AME ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_5 <- lm.cluster(formula=AME ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

m_6 <- lm.cluster(formula=AME ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

p_1 <- lm.cluster(formula=AME ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore/df$nmodel, cluster = "u_teamid", data = df)

p_2 <- lm.cluster(formula=AME ~ proindex + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore/df$nmodel, cluster = "u_teamid", data = df)

p_3 <- lm.cluster(formula=AME ~ group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore/df$nmodel, cluster = "u_teamid", data = df)

p_4 <- lm.cluster(formula=AME ~ group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore/df$nmodel, cluster = "u_teamid", data = df)

p_5 <- lm.cluster(formula=AME ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore/df$nmodel, cluster = "u_teamid", data = df)

p_6 <- lm.cluster(formula=AME ~ group1 + group3 + pbelief + stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore/df$nmodel, cluster = "u_teamid", data = df)

null_m <- m_1 <- lm.cluster(formula=AME ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = 1/df$nmodel, cluster = "u_teamid", data = df)

null_p <- lm.cluster(formula=AME ~ stats_brw + topic_brw + t2 + t3 + factor(mdegree), weights = df$pscore/df$nmodel, cluster = "u_teamid", data = df)

```

#### Build Table

```{r t2r}

Table_2 <- as.data.frame(matrix(nrow = 32, ncol = 8))

Table_2[,1] <- c("Variable", "A. Main regressions\nMean pro-imm. index", "", "Anti-immigration team", "", "Pro-immigration team", "", "Belief in hypothesis", "", "Statistical skills", "", "Topic experience", "", "Log-Lik", "AIC",  "R-squared", "", "B. Weighted by referee score\nMean pro-imm. index", "", "Anti-immigration team", "", "Pro-immigration team", "", "Belief in hypothesis", "", "Statistical skills", "", "Topic experience", "", "Log-Lik", "AIC", "R-squared")

Table_2[1,2:8] <- c("Null", "(1)", "(2)", "(3)", "(4)", "(5)", "(6)")

# function to get r-squared

r2ext <- function(model) {
  summary_output <- capture.output(summary(model))
  combined_output <- paste(summary_output, collapse = " ")
  r2_pattern <- "R\\^2\\s*[:=]\\s*(\\d+\\.\\d+|\\d+)"
  cleaned_output <- str_replace(combined_output, "R\\^2\\s*[:=]\\s*", "")
  first_number <- round(as.numeric(str_extract(cleaned_output, "\\d+\\.\\d+|\\d+")),3)
  return(first_number)
}

#m_ models
Table_2[c(10,12),2] <- round(as.numeric(null_m$lm_res$coefficients[2:3]),3)
Table_2[c(11,13),2] <- sprintf("(%s)", round(as.numeric(summary(null_m)[2:3,2]),3))

Table_2[c(2,10,12),3] <- round(as.numeric(m_1$lm_res$coefficients[2:4]),3)
Table_2[c(3,11,13),3] <- sprintf("(%s)", round(as.numeric(summary(m_1)[2:4,2]),3))

Table_2[c(2,8,10,12),4] <- round(as.numeric(m_2$lm_res$coefficients[2:5]),3)
Table_2[c(3,9,11,13),4] <- sprintf("(%s)", round(as.numeric(summary(m_2)[2:5,2]),3))

Table_2[c(6,10,12),5] <- round(as.numeric(m_3$lm_res$coefficients[2:4]),3)
Table_2[c(7,11,13),5] <- sprintf("(%s)", round(as.numeric(summary(m_3)[2:4,2]),3))

Table_2[c(6,8,10,12),6] <- round(as.numeric(m_4$lm_res$coefficients[2:5]),3)
Table_2[c(7,9,11,13),6] <- sprintf("(%s)", round(as.numeric(summary(m_4)[2:5,2]),3))

Table_2[c(4,6,10,12),7] <- round(as.numeric(m_5$lm_res$coefficients[2:5]),3)
Table_2[c(5,7,11,13),7] <- sprintf("(%s)", round(as.numeric(summary(m_5)[2:5,2]),3))

Table_2[c(4,6,8,10,12),8] <- round(as.numeric(m_6$lm_res$coefficients[2:6]),3)
Table_2[c(5,7,9,11,13),8] <- sprintf("(%s)", round(as.numeric(summary(m_6)[2:6,2]),3))

Table_2[16,2:8] <- c(r2ext(null_m), r2ext(m_1), r2ext(m_2), r2ext(m_3), r2ext(m_4), r2ext(m_5), r2ext(m_6))

Table_2[14,2:8] <- round(c(logLik((null_ml)), logLik(m_1l), logLik(m_2l), logLik(m_3l), logLik(m_4l), logLik(m_5l), logLik(m_6l)),2)

Table_2[15,2:8] <- round(c(AIC((null_ml)), AIC(m_1l), AIC(m_2l), AIC(m_3l), AIC(m_4l), AIC(m_5l), AIC(m_6l)),2)

#p_ models
Table_2[c(26,28),2] <- round(as.numeric(null_p$lm_res$coefficients[2:3]),3)
Table_2[c(27,29),2] <- sprintf("(%s)", round(as.numeric(summary(null_p)[2:3,2]),3))

Table_2[c(18,26,28),3] <- round(as.numeric(p_1$lm_res$coefficients[2:4]),3)
Table_2[c(19,27,29),3] <- sprintf("(%s)", round(as.numeric(summary(p_1)[2:4,2]),3))

Table_2[c(18,24,26,28),4] <- round(as.numeric(p_2$lm_res$coefficients[2:5]),3)
Table_2[c(19,25,27,29),4] <- sprintf("(%s)", round(as.numeric(summary(p_2)[2:5,2]),3))

Table_2[c(20,24,26,28),5] <- round(as.numeric(p_3$lm_res$coefficients[2:5]),3)
Table_2[c(21,25,27,29),5] <- sprintf("(%s)", round(as.numeric(summary(p_3)[2:5,2]),3))

Table_2[c(22,24,26,28),6] <- round(as.numeric(p_4$lm_res$coefficients[2:5]),3)
Table_2[c(23,25,27,29),6] <- sprintf("(%s)", round(as.numeric(summary(p_4)[2:5,2]),3))

Table_2[c(20,22,26,28),7] <- round(as.numeric(p_5$lm_res$coefficients[2:5]),3)
Table_2[c(21,23,27,29),7] <- sprintf("(%s)", round(as.numeric(summary(p_5)[2:5,2]),3))

Table_2[c(20,22,24,26,28),8] <- round(as.numeric(p_6$lm_res$coefficients[2:6]),3)
Table_2[c(21,23,25,27,29),8] <- sprintf("(%s)", round(as.numeric(summary(p_6)[2:6,2]),3))

Table_2[32,2:8] <- c(r2ext(null_p), r2ext(p_1), r2ext(p_2), r2ext(p_3), r2ext(p_4), r2ext(p_5), r2ext(p_6))

Table_2[30,2:8] <- round(c(logLik((null_pl)), logLik(p_1l), logLik(p_2l), logLik(p_3l), logLik(p_4l), logLik(p_5l), logLik(p_6l)),2)

Table_2[31,2:8] <- round(c(AIC((null_pl)), AIC(p_1l), AIC(p_2l), AIC(p_3l), AIC(p_4l), AIC(p_5l), AIC(p_6l)),2)

Table_2[is.na(Table_2)] <- ""

write_csv(Table_2, here::here("results", "Tbl2.csv"))

kable(Table_2, col.names = c("","","","","","","",""))


```

### Table 3

#### Build Models

It does not seem to be possible to both weight and cluster using glm binomial. So the cluster has to be done after.

##### Team size weights

In R, this needs to be starting from the integer of 1 for the lowest.

```{r t3, warning = F}
df$nmodel_l <- round((1/df$nmodel)*112,0)

m_1a <- glm(neg10 ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

# identical in Stata
#m_1as <- glm(neg10 ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
#             data = df_stata,
#             family = binomial(link = "logit"),
#             weights = nmodel_l)

m_2a <- glm(neg10 ~ dindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

m_3a <- glm(neg10 ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

m_1b <- glm(neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

m_2b <- glm(neg10s ~ dindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

m_3b <- glm(neg10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l)

m_1c <- glm(pos10 ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

m_2c <- glm(pos10 ~ dindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

m_3c <- glm(pos10 ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

m_1d <- glm(pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

m_2d <- glm(pos10s ~ dindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

m_3d <- glm(pos10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_l) 

```

##### Ref score weights

again adjust for the lowest weight at integer 1

```{r t3r, warning = F}

df$nmodel_lp <- round((df$pscore/df$nmodel)/(min(df$pscore/df$nmodel)), 0)

m_1ar <- glm(neg10 ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_2ar <- glm(neg10 ~ dindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_3ar <- glm(neg10 ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_1br <- glm(neg10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_2br <- glm(neg10s ~ dindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_3br <- glm(neg10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp)

m_1cr <- glm(pos10 ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_2cr <- glm(pos10 ~ dindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_3cr <- glm(pos10 ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_1dr <- glm(pos10s ~ proindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_2dr <- glm(pos10s ~ dindex + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

m_3dr <- glm(pos10s ~ group1 + group3 + stats_brw + topic_brw + t2 + t3 + factor(mdegree),
             data = df,
             family = binomial(link = "logit"),
             weights = nmodel_lp) 

```


#### Build Table

```{r se3s}

Table_3 <- as.data.frame(matrix(nrow = 19, ncol = 5))

Table_3[1,] <- c("", "(1)", "(2)", "(3)", "(3)")

Table_3[2,] <- c("Dependent variable", "Mean sentiment", "Pro-imm. team", "Anti-imm. team", "Pro-imm. team")

Table_3[,1] <- c("","Dependent vaiable", "A. Main regressions\nAME < 10th %", "", "AME < 10th % & sig.", "", "AME > 90th %", "", "AME > 90th % & sig.", "", "", "B. Weighted by referee score\nAME < 10th %",  "", "AME < 10th % & sig.", "", "AME > 90th %", "", "AME > 90th % & sig.", "")

# nu models weights
Table_3[3,2:5] <- round(c(summary(margins(m_1a, variables = "proindex"))[,2],
                          summary(margins(m_2a, variables = "dindex"))[,2],
                          summary(margins(m_3a, variables = "group1"))[,2],
                          summary(margins(m_3a, variables = "group3"))[,2]),3)

Table_3[5,2:5] <- round(c(summary(margins(m_1b, variables = "proindex"))[,2],
                          summary(margins(m_2b, variables = "dindex"))[,2],
                          summary(margins(m_3b, variables = "group1"))[,2],
                          summary(margins(m_3b, variables = "group3"))[,2]),3)

Table_3[7,2:5] <- round(c(summary(margins(m_1c, variables = "proindex"))[,2],
                          summary(margins(m_2c, variables = "dindex"))[,2],
                          summary(margins(m_3c, variables = "group1"))[,2],
                          summary(margins(m_3c, variables = "group3"))[,2]),3)

Table_3[9,2:5] <- round(c(summary(margins(m_1d, variables = "proindex"))[,2],
                          summary(margins(m_2d, variables = "dindex"))[,2],
                          summary(margins(m_3d, variables = "group1"))[,2],
                          summary(margins(m_3d, variables = "group3"))[,2]),3)
# peer review
Table_3[12,2:5] <- round(c(summary(margins(m_1ar, variables = "proindex"))[,2],
                          summary(margins(m_2ar, variables = "dindex"))[,2],
                          summary(margins(m_3ar, variables = "group1"))[,2],
                          summary(margins(m_3ar, variables = "group3"))[,2]),3)

Table_3[14,2:5] <- round(c(summary(margins(m_1br, variables = "proindex"))[,2],
                          summary(margins(m_2br, variables = "dindex"))[,2],
                          summary(margins(m_3br, variables = "group1"))[,2],
                          summary(margins(m_3br, variables = "group3"))[,2]),3)

Table_3[16,2:5] <- round(c(summary(margins(m_1cr, variables = "proindex"))[,2],
                          summary(margins(m_2cr, variables = "dindex"))[,2],
                          summary(margins(m_3cr, variables = "group1"))[,2],
                          summary(margins(m_3cr, variables = "group3"))[,2]),3)

Table_3[18,2:5] <- round(c(summary(margins(m_1dr, variables = "proindex"))[,2],
                          summary(margins(m_2dr, variables = "dindex"))[,2],
                          summary(margins(m_3dr, variables = "group1"))[,2],
                          summary(margins(m_3dr, variables = "group3"))[,2]),3)

# hack standard error as a proportion to the original based on the proportion of the standardized effect

# main models
Table_3[4,2:5] <- round(c(
  unname(
  coeftest(m_1a, vcov. = vcovCL(m_1a, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_1a, variables = "proindex"))[,2]
  / m_1a$coefficients[2]),
  unname(
  coeftest(m_2a, vcov. = vcovCL(m_2a, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_2a, variables = "dindex"))[,2]
  / m_2a$coefficients[2]),
  unname(
  coeftest(m_3a, vcov. = vcovCL(m_3a, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_3a, variables = "group1"))[,2]
  / m_3a$coefficients[2]),
  unname(
  coeftest(m_3a, vcov. = vcovCL(m_3a, cluster = ~ df$u_teamid))[3, 2] 
  * summary(margins(m_3a, variables = "group3"))[,2]
  / m_3a$coefficients[3])
),3)

Table_3[6,2:5] <- round(c(
  unname(
  coeftest(m_1b, vcov. = vcovCL(m_1b, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_1b, variables = "proindex"))[,2]
  / m_1b$coefficients[2]),
  unname(
  coeftest(m_2b, vcov. = vcovCL(m_2b, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_2b, variables = "dindex"))[,2]
  / m_2b$coefficients[2]),
  unname(
  coeftest(m_3b, vcov. = vcovCL(m_3b, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_3b, variables = "group1"))[,2]
  / m_3b$coefficients[2]),
  unname(
  coeftest(m_3b, vcov. = vcovCL(m_3b, cluster = ~ df$u_teamid))[3, 2] 
  * summary(margins(m_3b, variables = "group3"))[,2]
  / m_3b$coefficients[3])
),3)
  
Table_3[8,2:5] <- round(c(
  unname(
  coeftest(m_1c, vcov. = vcovCL(m_1c, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_1c, variables = "proindex"))[,2]
  / m_1c$coefficients[2]),
  unname(
  coeftest(m_2c, vcov. = vcovCL(m_2c, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_2c, variables = "dindex"))[,2]
  / m_2c$coefficients[2]),
  unname(
  coeftest(m_3c, vcov. = vcovCL(m_3c, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_3c, variables = "group1"))[,2]
  / m_3c$coefficients[2]),
  unname(
  coeftest(m_3c, vcov. = vcovCL(m_3c, cluster = ~ df$u_teamid))[3, 2] 
  * summary(margins(m_3c, variables = "group3"))[,2]
  / m_3c$coefficients[3])
),3)

Table_3[10,2:5] <- round(c(
  unname(
  coeftest(m_1d, vcov. = vcovCL(m_1d, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_1d, variables = "proindex"))[,2]
  / m_1d$coefficients[2]),
  unname(
  coeftest(m_2d, vcov. = vcovCL(m_2d, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_2d, variables = "dindex"))[,2]
  / m_2d$coefficients[2]),
  unname(
  coeftest(m_3d, vcov. = vcovCL(m_3d, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_3d, variables = "group1"))[,2]
  / m_3d$coefficients[2]),
  unname(
  coeftest(m_3d, vcov. = vcovCL(m_3d, cluster = ~ df$u_teamid))[3, 2] 
  * summary(margins(m_3d, variables = "group3"))[,2]
  / m_3d$coefficients[3])
),3)

# peer review models
Table_3[13,2:5] <- round(c(
  unname(
  coeftest(m_1ar, vcov. = vcovCL(m_1ar, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_1ar, variables = "proindex"))[,2]
  / m_1ar$coefficients[2]),
  unname(
  coeftest(m_2ar, vcov. = vcovCL(m_2ar, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_2ar, variables = "dindex"))[,2]
  / m_2ar$coefficients[2]),
  unname(
  coeftest(m_3ar, vcov. = vcovCL(m_3ar, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_3ar, variables = "group1"))[,2]
  / m_3ar$coefficients[2]),
  unname(
  coeftest(m_3ar, vcov. = vcovCL(m_3ar, cluster = ~ df$u_teamid))[3, 2] 
  * summary(margins(m_3ar, variables = "group3"))[,2]
  / m_3ar$coefficients[3])
),3)

Table_3[15,2:5] <- round(c(
  unname(
  coeftest(m_1br, vcov. = vcovCL(m_1br, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_1br, variables = "proindex"))[,2]
  / m_1br$coefficients[2]),
  unname(
  coeftest(m_2br, vcov. = vcovCL(m_2br, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_2br, variables = "dindex"))[,2]
  / m_2br$coefficients[2]),
  unname(
  coeftest(m_3br, vcov. = vcovCL(m_3br, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_3br, variables = "group1"))[,2]
  / m_3br$coefficients[2]),
  unname(
  coeftest(m_3br, vcov. = vcovCL(m_3br, cluster = ~ df$u_teamid))[3, 2] 
  * summary(margins(m_3br, variables = "group3"))[,2]
  / m_3br$coefficients[3])
),3)
  
Table_3[17,2:5] <- round(c(
  unname(
  coeftest(m_1cr, vcov. = vcovCL(m_1cr, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_1cr, variables = "proindex"))[,2]
  / m_1cr$coefficients[2]),
  unname(
  coeftest(m_2cr, vcov. = vcovCL(m_2cr, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_2cr, variables = "dindex"))[,2]
  / m_2cr$coefficients[2]),
  unname(
  coeftest(m_3cr, vcov. = vcovCL(m_3cr, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_3cr, variables = "group1"))[,2]
  / m_3cr$coefficients[2]),
  unname(
  coeftest(m_3cr, vcov. = vcovCL(m_3cr, cluster = ~ df$u_teamid))[3, 2] 
  * summary(margins(m_3cr, variables = "group3"))[,2]
  / m_3cr$coefficients[3])
),3)

Table_3[19,2:5] <- round(c(
  unname(
  coeftest(m_1dr, vcov. = vcovCL(m_1dr, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_1dr, variables = "proindex"))[,2]
  / m_1dr$coefficients[2]),
  unname(
  coeftest(m_2dr, vcov. = vcovCL(m_2dr, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_2dr, variables = "dindex"))[,2]
  / m_2dr$coefficients[2]),
  unname(
  coeftest(m_3dr, vcov. = vcovCL(m_3dr, cluster = ~ df$u_teamid))[2, 2] 
  * summary(margins(m_3dr, variables = "group1"))[,2]
  / m_3d$coefficients[2]),
  unname(
  coeftest(m_3dr, vcov. = vcovCL(m_3dr, cluster = ~ df$u_teamid))[3, 2] 
  * summary(margins(m_3dr, variables = "group3"))[,2]
  / m_3d$coefficients[3])
),3)

kable(Table_3, col.names = c("","","","",""))
```

### Table 4

#### Models

```{r t4m}
df_p <- subset(df, !is.na(peer_N))

m4_1 <- lm.cluster(formula= peer_mean ~ proindex + t2 + t3 + stats_brw + topic_brw  + factor(mdegree), weights = df_p$peer_N/df_p$nmodel, cluster = "u_teamid", data = df_p)

m4_2 <- lm.cluster(formula= peer_mean ~ dindex + t2 + t3 + stats_brw + topic_brw  + factor(mdegree), weights = df_p$peer_N/df_p$nmodel, cluster = "u_teamid", data = df_p)

m4_3 <- lm.cluster(formula= peer_mean ~ group1 + group3 + t2 + t3 + stats_brw + topic_brw  + factor(mdegree), weights = df_p$peer_N/df_p$nmodel, cluster = "u_teamid", data = df_p)


df_p$peer_nmodel <- round((df_p$peer_N/df_p$nmodel)/min(df_p$peer_N/df_p$nmodel), 0)

m4_4 <- glm(quality2 ~ proindex + t2 + t3 + stats_brw + topic_brw  + factor(mdegree),
             data = df_p,
             family = binomial(link = "logit"),
             weights = peer_nmodel)

m4_5 <- glm(quality2 ~ dindex + t2 + t3 + stats_brw + topic_brw + factor(mdegree),
             data = df_p,
             family = binomial(link = "logit"),
             weights = peer_nmodel) 

# problem with too many parameters here, combine a few to ease in estimation
df_p <- df_p %>%
  mutate(mdegreex = case_when(mdegree == 1 ~ 30,
                              mdegree == 6 ~ 30,
                              mdegree == 2 ~ 30,
                              .default = mdegree))

m4_6 <- glm(quality2 ~ group1 + group3 + t2 + t3 + stats_brw + topic_brw + mdegreex,
             data = df_p,
             family = binomial(link = "logit"),
             weights = peer_nmodel)
```

#### Build

```{r t4b}

Table_4 <- as.data.frame(matrix(nrow = 17, ncol = 7))

Table_4[,1] <- c("Variable:", "", "Mean pro-imm index", "", "Anti-imm, team", "", "Pro-imm, team", "", "Two-person team", "", "Three-person team", "", "Statistical skills", "", "Topic experience", "", "R-squared")

Table_4[1,c(3,6)] <- c("Mean referee score", "High quality indicator")

Table_4[2,2:7] <- c("(1)", "(2)", "(3)", "(1)", "(2)", "(3)")

# linear models
Table_4[c(3,9,11,13,15),2] <- round(c(summary(m4_1)[2:6,1]),3)
Table_4[c(4,10,12,14,16),2] <- round(c(summary(m4_1)[2:6,2]),3)

# logit clustered standard error hack
Table_4[3:4,5] <- round(c(summary(margins(m4_4, variables = "proindex"))[,2],
                    unname(
                      coeftest(m4_4, vcov. = vcovCL(m4_4, cluster = ~ df_p$u_teamid))[2, 2] * summary(margins(m4_4, variables = "proindex"))[,2] / m4_4$coefficients[2])),3)

Table_4[9:10,5] <- round(c(summary(margins(m4_4, variables = "t2"))[,2],
                    unname(
                      coeftest(m4_4, vcov. = vcovCL(m4_4, cluster = ~ df_p$u_teamid))[3, 2] * summary(margins(m4_4, variables = "t2"))[,2] / m4_4$coefficients[3])),3)

Table_4[11:12,5] <- round(c(summary(margins(m4_4, variables = "t3"))[,2],
                    unname(
                      coeftest(m4_4, vcov. = vcovCL(m4_4, cluster = ~ df_p$u_teamid))[4, 2] * summary(margins(m4_4, variables = "t3"))[,2] / m4_4$coefficients[4])),3)

Table_4[13:14,5] <- round(c(summary(margins(m4_4, variables = "stats_brw"))[,2],
                    unname(
                      coeftest(m4_4, vcov. = vcovCL(m4_4, cluster = ~ df_p$u_teamid))[5, 2] * summary(margins(m4_4, variables = "stats_brw"))[,2] / m4_4$coefficients[5])),3)

Table_4[15:16,5] <- round(c(summary(margins(m4_4, variables = "topic_brw"))[,2],
                    unname(
                      coeftest(m4_4, vcov. = vcovCL(m4_4, cluster = ~ df_p$u_teamid))[6, 2] * summary(margins(m4_4, variables = "topic_brw"))[,2] / m4_4$coefficients[6])),3)

# linear
Table_4[c(7,9,11,13,15),3] <- round(c(summary(m4_2)[2:6,1]),3)
Table_4[c(8,10,12,14,16),3] <- round(c(summary(m4_2)[2:6,2]),3)

# logit
Table_4[7:8,6] <- round(c(summary(margins(m4_5, variables = "dindex"))[,2],
                    unname(
                      coeftest(m4_5, vcov. = vcovCL(m4_5, cluster = ~ df_p$u_teamid))[2, 2] * summary(margins(m4_5, variables = "dindex"))[,2] / m4_5$coefficients[2])),3)

Table_4[9:10,6] <- round(c(summary(margins(m4_5, variables = "t2"))[,2],
                    unname(
                      coeftest(m4_5, vcov. = vcovCL(m4_5, cluster = ~ df_p$u_teamid))[3, 2] * (summary(margins(m4_5, variables = "t2"))[,2] / m4_5$coefficients[3]))),3)

Table_4[11:12,6] <- round(c(summary(margins(m4_5, variables = "t3"))[,2],
                    unname(
                      coeftest(m4_5, vcov. = vcovCL(m4_5, cluster = ~ df_p$u_teamid))[4, 2] * summary(margins(m4_5, variables = "t3"))[,2] / m4_5$coefficients[4])),3)

Table_4[13:14,6] <- round(c(summary(margins(m4_5, variables = "stats_brw"))[,2],
                    unname(
                      coeftest(m4_5, vcov. = vcovCL(m4_5, cluster = ~ df_p$u_teamid))[5, 2] * summary(margins(m4_5, variables = "stats_brw"))[,2] / m4_5$coefficients[5])),3)

Table_4[15:16,6] <- round(c(summary(margins(m4_5, variables = "topic_brw"))[,2],
                    unname(
                      coeftest(m4_5, vcov. = vcovCL(m4_5, cluster = ~ df_p$u_teamid))[6, 2] * summary(margins(m4_5, variables = "topic_brw"))[,2] / m4_5$coefficients[6])),3)

Table_4[c(5,7,9,11,13,15),4] <- round(c(summary(m4_3)[2:7,1]),3)
Table_4[c(6,8,10,12,14,16),4] <- round(c(summary(m4_3)[2:7,2]),3)

# logit
Table_4[5:6,7] <- round(c(summary(margins(m4_6, variables = "group1"))[,2],
                    unname(
                      coeftest(m4_6, vcov. = vcovCL(m4_6, cluster = ~ df_p$u_teamid))[2, 2] * summary(margins(m4_6, variables = "group1"))[,2] / m4_6$coefficients[2])),3)

Table_4[7:8,7] <- round(c(summary(margins(m4_6, variables = "group3"))[,2],
                    unname(
                      coeftest(m4_6, vcov. = vcovCL(m4_6, cluster = ~ df_p$u_teamid))[3, 2] * summary(margins(m4_6, variables = "group3"))[,2] / m4_6$coefficients[3])),3)

Table_4[9:10,7] <- round(c(summary(margins(m4_6, variables = "t2"))[,2],
                    unname(
                      coeftest(m4_6, vcov. = vcovCL(m4_6, cluster = ~ df_p$u_teamid))[4, 2] * (summary(margins(m4_6, variables = "t2"))[,2] / m4_6$coefficients[4]))),3)

Table_4[11:12,7] <- round(c(summary(margins(m4_6, variables = "t3"))[,2],
                    unname(
                      coeftest(m4_6, vcov. = vcovCL(m4_6, cluster = ~ df_p$u_teamid))[5, 2] * summary(margins(m4_6, variables = "t3"))[,2] / m4_6$coefficients[5])),3)

Table_4[13:14,7] <- round(c(summary(margins(m4_6, variables = "stats_brw"))[,2],
                    unname(
                      coeftest(m4_6, vcov. = vcovCL(m4_6, cluster = ~ df_p$u_teamid))[6, 2] * summary(margins(m4_6, variables = "stats_brw"))[,2] / m4_6$coefficients[6])),3)

Table_4[15:16,7] <- round(c(summary(margins(m4_6, variables = "topic_brw"))[,2],
                    unname(
                      coeftest(m4_6, vcov. = vcovCL(m4_6, cluster = ~ df_p$u_teamid))[7, 2] * summary(margins(m4_6, variables = "topic_brw"))[,2] / m4_6$coefficients[7])),3)

#for r-sqaured must calculate by hand
null_model <- glm(quality2 ~ 1, data = df_p, family = binomial(link = "logit"), weights = peer_nmodel)

Table_4[17,2:7] <- round(c(r2ext(m4_1), r2ext(m4_1), r2ext(m4_3), 1 - (logLik(m4_4) / logLik(null_model)), 1 - (logLik(m4_5) / logLik(null_model)), 1 - (logLik(m4_6) / logLik(null_model))),3)

Table_4[is.na(Table_4)] <- ""
kable(Table_4, col.names = c("", "", "", "", "", "", ""))
```

### Table 6

Refer to Stata code for now

```{r t6}

```

## Effect Decomp


### Data

From George Stata

```{r edecomp}

df_junkrej <- read_dta(here("Data", "junkrej.dta"))

# there is something wrong with the variable hreject in these data, generate new

minR <- min(1/df_junkrej$inv_weight_H)

df_junkrej <- df_junkrej %>%
  mutate(h_sup = ifelse(Hresult == "Support", 1, 0),
         h_rej = ifelse(Hresult == "Reject", 1, 0),
         # evidence in the form of both percent p and direction
         evidence_pos = case_when((pos_test_pct_p05 > 0.5 & meaname < -0.02) | pos_test_pct_p05 == 1 ~ 6,
                              pos_test_pct_p05 >= 0.5 | (meaname < -0.02 & pos_test_pct_p05 > 0) ~ 5,
                              pos_test_pct_p05 > 0.325 | (meaname < -0.01 & pos_test_pct_p05 > 0) ~ 4,
                              neg_test_pct_p05 > 0.4 & meaname > 0.01  & pos_test_pct_p05 < 0.2 ~ 1,
                              neg_test_pct_p05 > 0.325 | meaname > 0.01 ~ 2,

                              TRUE ~ 3),
         evidence_neg = case_when((neg_test_pct_p05 >= 0.5 & meaname > 0.02) | neg_test_pct_p05 == 1 ~ 6,
                              neg_test_pct_p05 > 0.5 | (meaname > 0.02 & neg_test_pct_p05 > 0) ~ 5,
                              neg_test_pct_p05 > 0.325 | (meaname > 0.01 & neg_test_pct_p05 > 0) ~ 4,
                              pos_test_pct_p05 > 0.5 & meaname < -0.02  & neg_test_pct_p05 < 0.2 ~ 1,
                              pos_test_pct_p05 > 0.325 | meaname < -0.01 ~ 2,
                              TRUE ~ 3),
         inv_weight_R = (1/inv_weight_H)/minR,
         team_size = factor(as.numeric(team_size)),
         mdegree = factor(as.numeric(mdegree)))
```


### Models

pb1 is if more than half the team believes in the hypothesis

```{r emodels}

e_tot <- lm(h_sup ~ group1 + group3 + stats_brw + topic_brw  
              + team_size + mdegree
              , data = df_junkrej, weights = inv_weight_R)

e_tot_r <- lm(h_rej ~ group1 + group3 + stats_brw + topic_brw 
                 + team_size + mdegree
                , data = df_junkrej, weights = inv_weight_R)

e_dir <- lm(h_sup ~ evidence_pos + group1 + group3 +  stats_brw + topic_brw 
                + team_size + mdegree
              , data = df_junkrej, weights = inv_weight_R)

e_dir_r <- lm(h_rej ~ evidence_neg + group1 + group3 +  stats_brw + topic_brw 
                 + team_size + mdegree
                , data = df_junkrej, weights = inv_weight_R)

e_ind <- lm(evidence_pos ~ group1 + group3 + stats_brw + topic_brw 
               + team_size + mdegree
              , data = df_junkrej, weights = inv_weight_R)

e_ind_r <- lm(evidence_neg ~ group1 + group3 + stats_brw + topic_brw 
                 + team_size + mdegree
                , data = df_junkrej, weights = inv_weight_R)



```

### Sobel's test Pos

```{r esobp}

a <- coef(e_ind)["group3"]  
b <- coef(e_dir)["evidence_pos"] 

se_a <- summary(e_ind)$coefficients["group3", "Std. Error"]  # 
se_b <- summary(e_dir)$coefficients["evidence_pos", "Std. Error"] 

indirect_effect <- a * b
se_indirect_effect <- sqrt((b^2 * se_a^2) + (a^2 * se_b^2))

# Perform Sobel's test
z_value <- indirect_effect / se_indirect_effect
p_value <- 2 * (1 - pnorm(abs(z_value)))

cat("Indirect effect: ", indirect_effect, "\n")
cat("Standard error of indirect effect: ", se_indirect_effect, "\n")
cat("Z-value: ", z_value, "\n")
cat("P-value: ", p_value, "\n")
```


### Sobel's test Neg

```{r esobn}
a <- coef(e_ind_r)["group3"]  
b <- coef(e_dir_r)["evidence_neg"]  

# Step 2: Extract the standard errors
se_a <- summary(e_ind_r)$coefficients["group3", "Std. Error"]  # Standard error for proindex in e_ind
se_b <- summary(e_dir_r)$coefficients["evidence_neg", "Std. Error"]  # Standard error for pos_test_pct_p05 in e_dir

# Step 3: Calculate the indirect effect and its standard error
indirect_effect <- a * b
se_indirect_effect <- sqrt((b^2 * se_a^2) + (a^2 * se_b^2))

# Step 4: Perform Sobel's test
z_value <- indirect_effect / se_indirect_effect
p_value <- 2 * (1 - pnorm(abs(z_value)))

cat("Indirect effect: ", indirect_effect, "\n")
cat("Standard error of indirect effect: ", se_indirect_effect, "\n")
cat("Z-value: ", z_value, "\n")
cat("P-value: ", p_value, "\n")
```

### Mediation Bootstrap

Doesn't work because it leaves out levels due to bootstrapping
```{r esobnmed}
mediate_model <- mediate(e_ind, e_dir, treat = "proindex", mediator = "meaname", 
                         boot = TRUE, sims = 1000)

# Summary of the results with bootstrapped standard errors
summary(mediate_model)
```
### Table

```{r tbl}

Table_Effects <- as.data.frame(matrix(nrow = 11, ncol = 7))

colnames(Table_Effects) <- c("Var", "Total_Pos", "Direct_Pos", "Indirect_Pos", "Total_Neg", "Direct_Neg", "Indirect_Neg")

Table_Effects[1,2:7] <- c("H Supported", "H Supported", "Pos Evidence Strength", "H Rejected", "H Rejected", "Neg Evidence Strength")

Table_Effects[,1] <- c("DV =", "Evidence Strength", "", "Anti-Immigrant", "", "Pro-Immigrant", "", "Stat Skills", "", "Topic Experience", "")

# pos
Table_Effects[c(4,6,8,10),2] <- round(as.numeric(e_tot$coefficients[2:5]),3)
Table_Effects[c(5,7,9,11),2] <-  round(as.numeric(summary(e_tot)$coefficients[2:5, "Std. Error"]),3)

Table_Effects[c(2,4,6,8,10),3] <- round(as.numeric(e_dir$coefficients[2:6]),3)
Table_Effects[c(3,5,7,9,11),3] <-  round(as.numeric(summary(e_dir)$coefficients[2:6, "Std. Error"]),3)

Table_Effects[c(4,6,8,10),4] <- round(as.numeric(e_ind$coefficients[2:5]),3)
Table_Effects[c(5,7,9,11),4] <-  round(as.numeric(summary(e_ind)$coefficients[2:5, "Std. Error"]),3)

# neg
Table_Effects[c(4,6,8,10),5] <- round(as.numeric(e_tot_r$coefficients[2:5]),3)
Table_Effects[c(5,7,9,11),5] <-  round(as.numeric(summary(e_tot_r)$coefficients[2:5, "Std. Error"]),3)

Table_Effects[c(2,4,6,8,10),6] <- round(as.numeric(e_dir_r$coefficients[2:6]),3)
Table_Effects[c(3,5,7,9,11),6] <-  round(as.numeric(summary(e_dir_r)$coefficients[2:6, "Std. Error"]),3)

Table_Effects[c(4,6,8,10),7] <- round(as.numeric(e_ind_r$coefficients[2:5]),3)
Table_Effects[c(5,7,9,11),7] <-  round(as.numeric(summary(e_ind_r)$coefficients[2:5, "Std. Error"]),3)

write_csv(Table_Effects, here("Results", "Table_Effects.csv"))
```

## Citations

```{r cites}

packages %>%
  map(citation) %>%
  print(style = "text")

```

## Colophon

```{r colo}

sessionInfo()

```

