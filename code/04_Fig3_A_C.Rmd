---
title: "03 Data Viz"
output: html_notebook
---
Replication workflow for:

"Ideological Bias in Estimates of the Impact of Immigration"

[George J. Borjas](https://www.hks.harvard.edu/faculty/george-borjas) <br>
[Nate Brezau](https://sites.google.com/site/nbreznau/) <br>

The original workflow was developed by Borjas using Stata (see `reg_model.do` in this repository), and this workflow is an identical set of analyses by Breznau done in R. 

The file `df.rds` (also available as csv) was generated in the file `01_Data_Prep.Rmd`.

## Setup

```{r setup}

packages <- c("tidyverse",
              "knitr",
              "pacman",
              "here",
              "ragg",
              "margins",
              "ggplot2")

pacman::p_load(packages, character.only = T)

# palette
colors <- c("#453781FF", "#3CBB75FF", "#F28C28")

```


## Data

```{r data}

df <- read_rds(here("data", "df.rds")) %>%
  mutate(index1 = group1,
         index2 = ifelse(group1 == 0 & group3 == 0, 1, 0),
         index3 = group3) %>%
  subset(!is.na(neg10s))
df_dyad <- read_csv(here("data", "df_dyad.csv")) %>%
  subset(!is.na(neg10s))


```

## Reg Models

Pull results from tables

```{r regs}


Table_S5 <- read_csv(here("Results", "TableS5.csv"))
Table_S7 <- read_csv(here("Results", "TableS7.csv"))

```
 
## Fig 3

### Predicted Margins
Use regression coefficients for group1 and group3 and predicted values for group2.


```{r amecalc}
# 
df$ame_group <- predict(m_3lm, newdata = df)
df$log_3n <- predict(log_3n, newdata = df, type = "response")

df_dyad$ame_group <- predict(m_3dlm, newdata = df_dyad)
df_dyad$log_3nd <- predict(log_3nd, newdata = df_dyad, type = "response")

df2 <- subset(df, group2 == 1) %>%
  mutate(ame_group2_m_3 = ame_group,
         ame_group2_p_3 = ame_group,
         log_group2_m_3 = log_3n)

df2_dyad <- subset(df_dyad, indiv2 == 1) %>%
  mutate(ame_group2_m_3 = ame_group,
         ame_group2_p_3 = ame_group,
         log_group2_m_3 = log_3nd) %>%
  subset(!is.na(ame_group))

# Weighted mean outcome
weighted_mean_ame_group2m <- sum(df2$ame_group2_m_3 * df2$mweight) / sum(df2$mweight)
weighted_mean_log_group2m <- sum(df2$log_group2_m_3 * df2$nmodel_l) / sum(df2$nmodel_l)

weighted_mean_ame_group2m_dyad <- sum(df2_dyad$ame_group2_m_3 * df2_dyad$mweight) / sum(df2_dyad$mweight)
weighted_mean_log_group2m_dyad <- sum(df2_dyad$log_group2_m_3 * df2_dyad$pweighta / sum(df2_dyad$pweighta))

weighted_mean_ame_group2p <- sum(df2$ame_group2_m_3 * df2$peerweight) / sum(df2$peerweight)

weighted_mean_ame_group2p_dyad <- sum(df2_dyad$ame_group2_m_3 * df2_dyad$peerweight) / sum(df2_dyad$peerweight)

weighted_var_ame_group2m <- sum(df2$mweight * (df2$ame_group2_m_3 - weighted_mean_ame_group2m)^2) / sum(df2$mweight)
weighted_var_log_group2m <- sum(df2$nmodel_l * (df2$log_group2_m_3 - weighted_mean_log_group2m)^2) / sum(df2$nmodel_l)

weighted_var_ame_group2m_dyad <- sum(df2_dyad$mweight * (df2_dyad$ame_group2_m_3 - weighted_mean_ame_group2m_dyad)^2) / sum(df2_dyad$mweight)
weighted_var_log_group2m_dyad <- sum(df2_dyad$pweighta * (df2_dyad$log_group2_m_3 - weighted_mean_log_group2m_dyad)^2) / sum(df2_dyad$pweighta)

weighted_var_ame_group2p <- sum(df2$peerweight * (df2$ame_group2_m_3 - weighted_mean_ame_group2p)^2) / sum(df2$peerweight)

weighted_var_ame_group2p_dyad <- sum(df2_dyad$peerweight * (df2_dyad$ame_group2_m_3 - weighted_mean_ame_group2p_dyad)^2) / sum(df2_dyad$peerweight)

weighted_se_ame_group2m <- sqrt(weighted_var_ame_group2m / sum(df2$mweight))
weighted_se_log_group2m <- sqrt(weighted_var_log_group2m / sum(df2$nmodel_l))

weighted_se_ame_group2m_dyad <- sqrt(weighted_var_ame_group2m_dyad / sum(df2_dyad$mweight))
weighted_se_log_group2m_dyad <- sqrt(weighted_var_log_group2m_dyad / sum(df2_dyad$pweighta))

weighted_se_ame_group2p <- sqrt(weighted_var_ame_group2p / sum(df2$peerweight))

weighted_se_ame_group2p_dyad <- sqrt(weighted_var_ame_group2p_dyad / sum(df2_dyad$peerweight))

# get coeffs
model_summary <- summary(m_3lm)
model_summaryp <- summary(p_3lm)
model_summary_log <- summary(margins(log_3n, variables = c("group1", "group3")))
model_summary_logd <- summary(margins(log_3nd, variables = c("indiv1", "indiv3")))

# Extract coefficients and standard errors for group1 and group3
coeff_group1 <- model_summary$coefficients["group1", "Estimate"]
se_group1 <- model_summary$coefficients["group1", "Std. Error"]

coeff_group1_log <- model_summary_log[1,2]
se_group1_log <- model_summary_log[1,3]

coeff_group3 <- model_summary$coefficients["group3", "Estimate"]
se_group3 <- model_summary$coefficients["group3", "Std. Error"]

coeff_group3_log <- model_summary_log[2,2]
se_group3_log <- model_summary_log[2,3]

coeff_group1p <- model_summaryp$coefficients["group1", "Estimate"]
se_group1p <- model_summaryp$coefficients["group1", "Std. Error"]

coeff_group3p <- model_summaryp$coefficients["group3", "Estimate"]
se_group3p <- model_summaryp$coefficients["group3", "Std. Error"]

model_summaryd <- summary(m_3dlm)
model_summarydp <- summary(p_3dlm)

# Extract coefficients and standard errors for group1 and group3
coeff_group1d <- model_summaryd$coefficients[grep("^indiv1$", rownames(model_summaryd$coefficients)), "Estimate"]
se_group1d <- model_summaryd$coefficients[grep("^indiv1$", rownames(model_summaryd$coefficients)), "Std. Error"]

coeff_group1d_log <- model_summary_logd[1,2]
se_group1d_log <- model_summary_logd[1,3]

coeff_group3d <- model_summaryd$coefficients[grep("^indiv3$", rownames(model_summaryd$coefficients)), "Estimate"]
se_group3d <- model_summaryd$coefficients[grep("^indiv3$", rownames(model_summaryd$coefficients)), "Std. Error"]

coeff_group3d_log <- model_summary_logd[2,2]
se_group3d_log <- model_summary_logd[2,3]

coeff_group1dp <- model_summarydp$coefficients[grep("^indiv1$", rownames(model_summarydp$coefficients)), "Estimate"]
se_group1dp <- model_summarydp$coefficients[grep("^indiv1$", rownames(model_summarydp$coefficients)), "Std. Error"]

coeff_group3dp <- model_summarydp$coefficients[grep("^indiv1$", rownames(model_summarydp$coefficients)), "Estimate"]
se_group3dp <- model_summarydp$coefficients[grep("^indiv1$", rownames(model_summarydp$coefficients)), "Std. Error"]
```

### Plotting DFs

```{r coefplot2}

plot_data_ame <- data.frame(
  group = c("group1", 
            "group2", 
            "group3", 
            "group1", 
            "group2", 
            "group3"),
  weight = c("lin", "lin", "lin", "log", "log", "log"),
  mean = c(coeff_group1 + weighted_mean_ame_group2m,
           weighted_mean_ame_group2m,
           coeff_group3 + weighted_mean_ame_group2m,
           coeff_group1_log + weighted_mean_log_group2m,
           weighted_mean_log_group2m,
           coeff_group3p + weighted_mean_log_group2m),
  se = c(se_group1, weighted_se_ame_group2m, se_group3,
         se_group1_log, weighted_se_log_group2m, se_group3_log))

plot_data_ame_dyad <- data.frame(
  group = c("group1", 
            "group2", 
            "group3", 
            "group1", 
            "group2", 
            "group3"),
  weight = c("lin", "lin", "lin", "log", "log", "log"),
  mean = c(coeff_group1d+weighted_mean_ame_group2m_dyad, weighted_mean_ame_group2m_dyad, coeff_group3d+weighted_mean_ame_group2m_dyad,
           coeff_group1d_log + weighted_mean_log_group2m_dyad, weighted_mean_log_group2m_dyad, coeff_group3d_log+weighted_mean_log_group2m_dyad),
  se = c(se_group1d, weighted_se_ame_group2m_dyad, se_group3d,
         se_group1d_log, weighted_se_log_group2m_dyad, se_group3d_log)
)
# the standard errors came out unweighted here, readjust based on ratio of coefficient to se in original regression

plot_data_ame <- plot_data_ame %>%
  mutate(rat = (abs(mean)/abs(se)),
         rat = ifelse(weight == "log" & group == "group1",  (summary(log_3n)$coefficients[2,1] / summary(log_3n)$coefficients[2,2]), rat),
         rat = ifelse(weight == "log" & group == "group3", 
                      #note: increased se slightly to visualize in plot
                      (abs(summary(log_3n)$coefficients[3,1])/2 / abs(summary(log_3n)$coefficients[3,2])), rat))

#make se slightly larger
plot_data_ame[5,5] <- plot_data_ame[2,5]

plot_data_ame <- plot_data_ame %>%
  mutate(se = ifelse(weight == "log", mean/rat, se))




plot_data_ame_dyad <- plot_data_ame_dyad %>%
  mutate(rat = (abs(mean)/abs(se)),
         rat = ifelse(weight == "log" & group == "group1",  (summary(log_3nd)$coefficients[2,1] / summary(log_3nd)$coefficients[2,2]), rat),
         rat = ifelse(weight == "log" & group == "group3",  (abs(summary(log_3nd)$coefficients[3,1]) / abs(summary(log_3nd)$coefficients[3,2])), rat))


plot_data_ame_dyad[5,5] <- plot_data_ame_dyad[2,5] 

plot_data_ame_dyad <- plot_data_ame_dyad %>%
  mutate(se = ifelse(weight == "log", mean/rat, se))



```

### Table-based scores

```{r tablebased}

```

### Fig3A Model

```{r fig2a}
agg_png(here("results", "Fig3A.png"), res = 144, height = 300, width = 650)

plot_data_ame %>%
  ggplot(aes(x = factor(group, levels = rev(unique(group))), y = mean, color = group)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean - 1.645 * se, ymax = mean + 1.645 * se), width = 0.1) +
  labs(x = "Variables", y = "Marginal Effects", title = "") +
  #geom_hline(yintercept = 0, linetype = "dotted", color = "grey") + 
  ylim(-0.04,0.34) +
  annotate("text", y = c(coeff_group1 + weighted_mean_ame_group2m,
                         weighted_mean_ame_group2m,
                         coeff_group3 + weighted_mean_ame_group2m), 
           x = c(2.7,1.7,0.7),
           label = c("Anti-immigration", "Moderate", "Pro-immigration"),
           color = colors[1:3],
           size = 3) +
  coord_flip() +
  scale_color_manual(values = colors) +
  theme_classic() +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.position = "none")

dev.off()

knitr::include_graphics(here("results", "Fig3A.png"))
```


```{r fig2ax}
agg_png(here("results", "Fig3Anew.png"), res = 144, height = 300, width = 650)

ggplot(plot_data_ame, aes(x = weight, y = mean, color = group, group = group)) +
  geom_point(position = position_dodge(width = 0.4), size = 3) +  # Dodge to separate groups
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2 
                ,position = position_dodge(width = 0.4)
                ) +  # Error bars with dodge
  labs(x = "Model", y = "Predicted Probability", color = "Group") +
  annotate("text", y = c(0.04,
                         0.156,
                         0.24), 
           x = c(1.7,1.5,1.3),
           label = c("Pro-\nimmigration", "Moderate", "Anti-\nimmigration"),
           color = colors[c(3,2,1)],
           size = 3) +
  scale_color_manual(values = colors) +
  scale_x_discrete(labels = c("lin" = "Linear", "log" = "Logistic")) +
  theme_classic() +
  coord_flip() +
  theme(legend.position = "none",
        axis.title.y = element_blank()
        )

dev.off()

knitr::include_graphics(here("results", "Fig3Anew.png"))
```



### Fig3C Dyad

```{r fig2c}
agg_png(here("results", "Fig3C.png"), res = 144, height = 300, width = 650)

plot_data_ame_dyad %>%
  subset(weight == "m") %>%
  ggplot(aes(x = factor(group, levels = rev(unique(group))), y = mean, color = group)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean - 1.645 * se, ymax = mean + 1.645 * se), width = 0.1) +
  labs(x = "Variables", y = "Marginal Effects", title = "") +
  #geom_hline(yintercept = 0, linetype = "dotted", color = "grey") + 
  ylim(-0.04,0.34) +
  annotate("text", y = c(coeff_group1d + weighted_mean_ame_group2m_dyad,
                         weighted_mean_ame_group2m_dyad,
                         coeff_group3d + weighted_mean_ame_group2m_dyad), 
           x = c(2.7,1.7,0.7),
           label = c("Anti-immigration", "Moderate", "Pro-immigration"),
           color = colors[1:3],
           size = 3) +
  coord_flip() +
  scale_color_manual(values = colors) +
  theme_classic() +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.position = "none")

dev.off()

knitr::include_graphics(here("results", "Fig3C.png"))
```

